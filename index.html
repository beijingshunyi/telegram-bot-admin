const SUPABASE_URL = "https://tekuxjnnwtqmygibvwux.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRla3V4am5ud3RxbXlnaWJ2d3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNDUzNjAsImV4cCI6MjA3MDkyMTM2MH0.RGmuF44husXoJP8y4U1Gx7HqQJ6MsYZVl6_vHtG-KJY";
const BOT_TOKEN = "8341196303:AAFbT_px8I12_q2b7AI_c00N3nHzFwLb4pg";
const ADMIN_ID = 8392100400;
const CHANNEL_IDS = ["-1002841497873", "-1002795304513", "-1002834136499", "-1002615160035"];
const GROUP_IDS = ["-1002737769800", "-1002735235059"];
const ADMIN_API_KEY = "MySuperSecureKey123!"; 

// 处理OPTIONS请求
function handleOptions() {
  return new Response(null, {
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Admin-Key',
      'Access-Control-Max-Age': '86400'
    }
  });
}

// 设置CORS头
function setCorsHeaders(response) {
  const headers = new Headers(response.headers);
  headers.set('Access-Control-Allow-Origin', '*');
  return new Response(response.body, {
    status: response.status,
    statusText: response.statusText,
    headers: headers
  });
}

async function handleRequest(request) {
  try {
    const url = new URL(request.url);
    
    if (request.method === "OPTIONS") {
      return handleOptions();
    }

    // 测试数据库连接
    if (request.method === "GET" && url.pathname === "/test-db") {
      const response = await testDatabaseConnection();
      return setCorsHeaders(response);
    }

    // 定时任务
    if (request.method === "GET" && url.pathname === "/send-random-teacher") {
      const response = await handleSendRandomTeacher();
      return setCorsHeaders(response);
    }

    // 后台管理API
    if (request.method === "POST" && url.pathname === "/admin-api") {
      const response = await handleAdminAPI(request);
      return setCorsHeaders(response);
    }

    // Telegram更新处理
    if (request.method === "POST") {
      const update = await request.json();
      return handleUpdate(update);
    }

    return new Response("Telegram Bot is running");
  } catch (e) {
    console.error("全局错误:", e);
    return setCorsHeaders(new Response(JSON.stringify({ 
      error: "服务器错误", 
      details: e.message 
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    }));
  }
}

// 测试数据库连接
async function testDatabaseConnection() {
  try {
    const users = await supabaseFetchAll('users');
    return new Response(JSON.stringify({
      status: "success",
      users_count: users.length
    }), {
      headers: { "Content-Type": "application/json" }
    });
  } catch (error) {
    return new Response(JSON.stringify({
      status: "error",
      message: error.message
    }), {
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}

// 管理员API处理
async function handleAdminAPI(request) {
  const apiKey = request.headers.get('Admin-Key');

  console.log("收到的API密钥:", apiKey ? "存在" : "不存在");
  console.log("预期的API密钥:", ADMIN_API_KEY);
  
  if (!apiKey || apiKey !== ADMIN_API_KEY) {
    console.warn(`密钥验证失败: 收到${apiKey || '空值'}`);
    return new Response(JSON.stringify({ 
      error: "Unauthorized",
      message: "管理员密钥不正确"
    }), {
      status: 401,
      headers: { "Content-Type": "application/json" }
    });
  }

  try {
    const { action, table, data, filter } = await request.json();

    const validTables = ['users', 'teachers', 'keywords', 'banned_keywords'];
    if (!validTables.includes(table)) {
      throw new Error(`非法表名: ${table}`);
    }

    switch (action) {
      case "get":
        const records = await supabaseFetchAll(table, filter);
        return new Response(JSON.stringify(records), {
          headers: { "Content-Type": "application/json" }
        });
      case "update":
        await supabaseUpsert(table, data, 'id');
        return new Response(JSON.stringify({ status: "success" }), {
          headers: { "Content-Type": "application/json" }
        });
      case "insert":
        await supabaseInsert(table, data);
        return new Response(JSON.stringify({ status: "success" }), {
          headers: { "Content-Type": "application/json" }
        });
      case "delete":
        await supabaseDelete(table, data.id);
        return new Response(JSON.stringify({ status: "success" }), {
          headers: { "Content-Type": "application/json" }
        });
      default:
        return new Response(JSON.stringify({ error: "Invalid action" }), { status: 400 });
    }
  } catch (error) {
    console.error("管理API错误:", error);
    return new Response(JSON.stringify({ 
      error: "数据库操作失败",
      details: error.message 
    }), { 
      status: 500,
      headers: { "Content-Type": "application/json" }
    });
  }
}

// Telegram消息处理
async function handleUpdate(update) {
  if (!update.message) return new Response("OK");
  
  const { message } = update;
  const chatId = message.chat.id;
  const userId = message.from.id;
  const text = message.text || "";
  
  console.log(`收到消息: ${text}`);
  
  const keywordResponse = await handleKeywordReply(text, chatId);
  if (keywordResponse) return keywordResponse;
  
  const banResponse = await handleBannedKeyword(text, message);
  if (banResponse) return banResponse;
  
  if (text === "签到") {
    return handleSign(chatId, userId, message.from);
  }
  
  if (text === "积分") {
    return handlePoints(chatId, userId);
  }
  
  if (text === "积分排行") {
    return handlePointsRanking(chatId);
  }
  
  if (text === "上传老师") {
    const template = "📸 请发送照片和老师信息，格式如下：\n\n花名,年龄,地区,Telegram账号,频道链接,服务类型,修车费,自我介绍\n\n示例：\n甜甜,18,昌平天通苑,@lisifu,https://t.me/lisifu_channel,毒龙 69 深喉等,600p 1200pp,温柔体贴 不催人 不机车";
    return sendMessage(chatId, template);
  }
  
  if (message.photo) {
    return handlePhotoMessage(message, chatId);
  }
  
  return new Response("OK");
}

// 签到功能
async function handleSign(chatId, userId, userInfo) {
  try {
    const today = new Date().toISOString().split('T')[0];
    const user = await supabaseFetch('users', `user_id=eq.${userId}`);
    
    if (user && user.last_sign_date === today) {
      return sendMessage(chatId, "❌ 您今天已经签到过了！", message.message_id);
    }
    
    const points = user ? (user.points || 0) + 10 : 10;
    
    const userData = {
      user_id: userId,
      points,
      last_sign_date: today,
      username: userInfo.username || "",
      first_name: userInfo.first_name || "",
      last_name: userInfo.last_name || "",
      display_name: userInfo.display_name || "" 
    };
    
    await supabaseUpsert('users', userData, 'user_id');
    
    const todaySigns = await supabaseFetchAll('users', `last_sign_date=eq.${today}`);
    const signRank = todaySigns.length;
    
    return sendMessage(chatId, `🎉 签到成功！+10积分\n💰 当前积分: ${points}\n🏆 您是今日第${signRank}位签到成员`, message.message_id);
  } catch (error) {
    console.error("签到错误:", error);
    return sendMessage(chatId, "❌ 签到失败，请稍后再试", message.message_id);
  }
}

// 积分查询
async function handlePoints(chatId, userId) {
  try {
    const user = await supabaseFetch('users', `user_id=eq.${userId}`);
    const points = user ? (user.points || 0) : 0;
    
    const allUsers = await supabaseFetchAll('users');
    allUsers.sort((a, b) => (b.points || 0) - (a.points || 0));
    const userRank = allUsers.findIndex(u => u.user_id === userId) + 1;
    
    const displayName = user.display_name || `${user.first_name} ${user.last_name}` || user.username || '未知用户';
    return sendMessage(chatId, `💰 ${displayName}的当前积分: ${points}\n🏆 在本群排名: ${userRank}/${allUsers.length}`, message.message_id);
  } catch (error) {
    console.error("积分查询错误:", error);
    return sendMessage(chatId, "❌ 查询积分失败", message.message_id);
  }
}

// 积分排行
async function handlePointsRanking(chatId) {
  try {
    const allUsers = await supabaseFetchAll('users');
    allUsers.sort((a, b) => (b.points || 0) - (a.points || 0));
    
    let rankMsg = "🏆 积分排行榜 TOP 10 🏆\n\n";
    const topUsers = allUsers.slice(0, 10);
    
    topUsers.forEach((user, index) => {
      const displayName = user.display_name || `${user.first_name} ${user.last_name}` || user.username || '未知用户';
      rankMsg += `${index + 1}. ${displayName}: ${user.points || 0}分\n`;
    });
    
    return sendMessage(chatId, rankMsg);
  } catch (error) {
    console.error("积分排名错误:", error);
    return sendMessage(chatId, "❌ 获取积分排名失败", message.message_id);
  }
}

// 关键词回复功能
async function handleKeywordReply(text, chatId) {
  const keywords = await getKeywordReplies();
  const lowerText = text.toLowerCase();
  
  for (const [keyword, reply] of Object.entries(keywords)) {
    if (lowerText.includes(keyword.toLowerCase())) {
      await sendMessage(chatId, reply, message.message_id);
      return new Response("OK");
    }
  }
  return null;
}

// 获取关键词回复
async function getKeywordReplies() {
  try {
    const keywords = await supabaseFetchAll('keywords', 'is_active=eq.true');
    const keywordMap = {};
    keywords.forEach(k => {
      keywordMap[k.keyword] = k.response;
    });
    return keywordMap;
  } catch (error) {
    console.error("获取关键词失败:", error);
    return {
      "你好": "您好！有什么可以帮您？",
      "帮助": "这里是帮助信息：\n- 签到：发送「签到」\n- 积分查询：发送「积分」",
      "价格": "服务价格表：\n- 基础课程：100积分\n- 高级课程：300积分"
    };
  }
}

// 禁言系统
async function handleBannedKeyword(text, message) {
  const bannedKeywords = await getBannedKeywords();
  const lowerText = text.toLowerCase();
  
  for (const keyword of bannedKeywords) {
    if (lowerText.includes(keyword.toLowerCase())) {
      if (message.chat.type === 'group' || message.chat.type === 'supergroup') {
        const chatId = message.chat.id;
        const userId = message.from.id;
        
        await deleteMessage(chatId, message.message_id);
        await restrictChatMember(chatId, userId, 3600);
        
        await sendMessage(chatId, `用户 @${message.from.username || message.from.first_name} 因发送违禁词已被禁言1小时。`, message.message_id);
      }
      return new Response("OK");
    }
  }
  return null;
}

// 获取禁言词
async function getBannedKeywords() {
  try {
    const banned = await supabaseFetchAll('banned_keywords');
    return banned.map(b => b.keyword);
  } catch (error) {
    console.error("获取禁言词失败:", error);
    return ["赌博", "毒品", "诈骗", "广告"];
  }
}

// 老师上传功能
async function handlePhotoMessage(message, chatId) {
  try {
    const photo = message.photo[message.photo.length - 1];
    const photoUrl = await getFileUrl(photo.file_id);
    const caption = message.caption || "";
    
    if (!caption) {
      return sendMessage(chatId, "❌ 请添加说明文字，格式：花名,年龄,地区,Telegram账号,频道链接,服务类型,修车费,自我介绍", message.message_id);
    }
    
    const fields = caption.split(',').map(field => field.trim());
    
    if (fields.length < 8) {
      return sendMessage(chatId, `❌ 信息格式错误，请按以下格式发送：\n\n花名,年龄,地区,Telegram账号,频道链接,服务类型,修车费,自我介绍\n\n当前字段数: ${fields.length}/8\n\n示例：\n甜甜,18,昌平天通苑,@lisifu,https://t.me/lisifu_channel,毒龙 69 深喉等,600p 1200pp,温柔体贴 不催人 不机车`, message.message_id);
    }
    
    const teacherData = {
      nickname: fields[0],
      age: parseInt(fields[1]) || 0,
      region: fields[2],
      telegram_account: fields[3],
      channel: fields[4],
      service_type: fields[5],
      price: fields[6], 
      intro: fields[7],
      photo_url: photoUrl,
      status: 'pending'
    };
    
    await supabaseInsert('teachers', teacherData);
    await sendTeacherToChannels(teacherData);
    
    return sendMessage(chatId, "✅ 老师信息已成功上传并分享！", message.message_id);
  } catch (error) {
    console.error("照片处理错误:", error);
    return sendMessage(chatId, `❌ 上传失败: ${error.message}`, message.message_id);
  }
}

// 发送老师资料到频道
async function sendTeacherToChannels(teacher) {
  try {
    const caption = `🌟 新老师推荐 🌟\n\n` +
                   `花名: ${teacher.nickname}\n` +
                   `年龄: ${teacher.age}\n` +
                   `地区: ${teacher.region}\n` +
                   `Telegram账号: ${teacher.telegram_account}\n` +
                   `频道: ${teacher.channel}\n` +
                   `服务类型: ${teacher.service_type}\n` +
                   `费用: ${teacher.price}\n` +
                   `自我介绍: ${teacher.intro}`;

    for (const channelId of CHANNEL_IDS) {
      await sendPhotoToChannel(channelId, teacher.photo_url, caption);
    }
    
    for (const groupId of GROUP_IDS) {
      await sendPhotoToChannel(groupId, teacher.photo_url, caption);
    }
  } catch (error) {
    console.error("发送老师资料到频道失败:", error);
  }
}

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北京修车【万花楼】超级机器人管理后台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #185A56;
            --secondary-color: #FD742D;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .sidebar-header p {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .menu-section {
            margin-bottom: 25px;
        }
        
        .menu-title {
            padding: 0 20px 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            opacity: 0.7;
            letter-spacing: 1px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .menu-item:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .menu-item.active {
            background-color: rgba(255,255,255,0.15);
            color: white;
            border-left-color: var(--secondary-color);
        }
        
        .menu-item i {
            margin-right: 12px;
            font-size: 1.1rem;
        }
        
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.8rem;
            text-align: center;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .top-bar {
            height: 60px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 100;
        }
        
        .page-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info .dropdown-toggle {
            display: flex;
            align-items: center;
            color: #495057;
            text-decoration: none;
        }
        
        .user-info i {
            font-size: 1.5rem;
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 15px 20px;
            font-weight: 600;
            color: var(--primary-color);
            border-radius: 10px 10px 0 0 !important;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: #14433f;
            border-color: #14433f;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-secondary:hover, .btn-secondary:focus {
            background-color: #e5661f;
            border-color: #e5661f;
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-secondary {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-outline-secondary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .table {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-weight: 500;
        }
        
        .table td, .table th {
            vertical-align: middle;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(24, 90, 86, 0.05);
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .badge.bg-success {
            background-color: #28a745 !important;
        }
        
        .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #212529 !important;
        }
        
        .badge.bg-danger {
            background-color: #dc3545 !important;
        }
        
        .badge.bg-secondary {
            background-color: #6c757d !important;
        }
        
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }
        
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
        
        .modal-footer {
            background-color: #f8f9fa;
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(24, 90, 86, 0.25);
        }
        
        .pagination .page-link {
            color: var(--primary-color);
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .teacher-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 5px;
        }
        
        .video-preview {
            max-width: 300px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 5px;
        }
        
        .scheduled-task-image {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .upload-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 350px;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .stats-card {
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card h5 {
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .stats-card h2 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stats-card p {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-action {
            padding: 5px 10px;
            font-size: 0.875rem;
        }
        
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            padding: 40px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
        }
        
        .form-floating label {
            color: var(--primary-color);
        }
        
        .form-control {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 12px;
        }
        
        .btn-login {
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-login:hover {
            background-color: #14433f;
        }
        
        .nav-tabs .nav-link {
            color: var(--primary-color);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .media-upload-area {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .media-upload-area:hover {
            border-color: var(--primary-color);
        }
        
        .media-upload-area i {
            font-size: 2rem;
            color: #ced4da;
            margin-bottom: 10px;
        }
        
        .media-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .media-preview {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ced4da;
        }
        
        .media-preview img,
        .media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-preview .remove-media {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .custom-file-upload {
            display: inline-block;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .custom-file-upload:hover {
            background-color: #14433f;
        }
        
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>
    
    <!-- 登录界面 -->
    <div class="login-container" id="loginContainer">
        <div class="login-logo">
            <i class="bi bi-robot"></i>
        </div>
        <h2 class="login-title">北京修车【万花楼】超级机器人管理后台</h2>
        <div class="form-floating mb-3">
            <input type="password" class="form-control" id="adminKey" placeholder="管理员密钥">
            <label for="adminKey">管理员密钥</label>
        </div>
        <button class="btn btn-primary btn-login" onclick="login()">登录</button>
        <div class="mt-3 text-center">
            <small class="text-muted">请输入正确的管理员密钥以继续</small>
        </div>
    </div>
    
    <!-- 主界面 -->
    <div class="main-container" id="mainContainer" style="display: none;">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>北京修车【万花楼】</h3>
                <p>超级机器人管理后台</p>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-title">系统概览</div>
                    <a href="#" class="menu-item active" onclick="showSection('dashboard')">
                        <i class="bi bi-speedometer2"></i>
                        <span>运行仪表盘</span>
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">用户管理</div>
                    <a href="#" class="menu-item" onclick="showSection('users')">
                        <i class="bi bi-people"></i>
                        <span>用户管理</span>
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">老师管理</div>
                    <a href="#" class="menu-item" onclick="showSection('teachers')">
                        <i class="bi bi-person-badge"></i>
                        <span>老师管理</span>
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">内容管理</div>
                    <a href="#" class="menu-item" onclick="showSection('keywords')">
                        <i class="bi bi-key"></i>
                        <span>关键词管理</span>
                    </a>
                    <a href="#" class="menu-item" onclick="showSection('banned')">
                        <i class="bi bi-shield-x"></i>
                        <span>禁言词管理</span>
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">任务管理</div>
                    <a href="#" class="menu-item" onclick="showSection('scheduled')">
                        <i class="bi bi-clock-history"></i>
                        <span>定时发送任务</span>
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-title">系统设置</div>
                    <a href="#" class="menu-item" onclick="showSection('settings')">
                        <i class="bi bi-gear"></i>
                        <span>系统设置</span>
                    </a>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <p>© 2023 北京修车【万花楼】</p>
                <p>超级机器人管理系统</p>
            </div>
        </div>
        
        <!-- 内容区域 -->
        <div class="content-area">
            <!-- 顶部栏 -->
            <div class="top-bar">
                <div class="page-title" id="pageTitle">运行仪表盘</div>
                <div class="user-info">
                    <div class="dropdown">
                        <a href="#" class="dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i>
                            <span>管理员</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="logout()">退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 内容区 -->
            <div class="content">
                <!-- 仪表盘 -->
                <div id="dashboardSection" class="content-section active">
                    <div class="row mb-4">
                        <div class="col-md-3 mb-4">
                            <div class="card stats-card">
                                <div class="card-body">
                                    <h5 class="card-title">用户总数</h5>
                                    <h2 class="text-primary" id="totalUsers">-</h2>
                                    <p class="card-text">注册用户数量</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card stats-card">
                                <div class="card-body">
                                    <h5 class="card-title">老师总数</h5>
                                    <h2 class="text-success" id="totalTeachers">-</h2>
                                    <p class="card-text">已注册老师数量</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card stats-card">
                                <div class="card-body">
                                    <h5 class="card-title">关键词总数</h5>
                                    <h2 class="text-warning" id="totalKeywords">-</h2>
                                    <p class="card-text">已设置关键词数量</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card stats-card">
                                <div class="card-body">
                                    <h5 class="card-title">禁言词总数</h5>
                                    <h2 class="text-danger" id="totalBanned">-</h2>
                                    <p class="card-text">已设置禁言词数量</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>最近用户</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>用户名</th>
                                                    <th>积分</th>
                                                    <th>最后签到</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentUsers">
                                                <tr>
                                                    <td colspan="4" class="text-center">加载中...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>最近老师</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>花名</th>
                                                    <th>年龄</th>
                                                    <th>地区</th>
                                                    <th>状态</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentTeachers">
                                                <tr>
                                                    <td colspan="4" class="text-center">加载中...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 用户管理 -->
                <div id="usersSection" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>用户管理</h5>
                            <button class="btn btn-primary" onclick="showAddUserModal()">
                                <i class="bi bi-plus-circle me-1"></i> 添加用户
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="搜索用户..." id="userSearch">
                                    <button class="btn btn-outline-primary" type="button" onclick="searchUsers()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用户名</th>
                                            <th>显示名称</th>
                                            <th>积分</th>
                                            <th>消息数</th>
                                            <th>最后签到</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTable">
                                        <tr>
                                            <td colspan="7" class="text-center">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="usersPagination">
                                    <!-- 分页按钮将通过JS动态生成 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- 老师管理 -->
                <div id="teachersSection" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>老师管理</h5>
                            <button class="btn btn-primary" onclick="showAddTeacherModal()">
                                <i class="bi bi-plus-circle me-1"></i> 添加老师
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="搜索老师..." id="teacherSearch">
                                    <button class="btn btn-outline-primary" type="button" onclick="searchTeachers()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>头像</th>
                                            <th>ID</th>
                                            <th>花名</th>
                                            <th>年龄</th>
                                            <th>地区</th>
                                            <th>账号</th>
                                            <th>服务类型</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teachersTable">
                                        <tr>
                                            <td colspan="9" class="text-center">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="teachersPagination">
                                    <!-- 分页按钮将通过JS动态生成 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- 关键词管理 -->
                <div id="keywordsSection" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>关键词管理</h5>
                            <button class="btn btn-primary" onclick="showAddKeywordModal()">
                                <i class="bi bi-plus-circle me-1"></i> 添加关键词
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="搜索关键词..." id="keywordSearch">
                                    <button class="btn btn-outline-primary" type="button" onclick="searchKeywords()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>关键词</th>
                                            <th>回复内容</th>
                                            <th>自定义回复</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="keywordsTable">
                                        <tr>
                                            <td colspan="6" class="text-center">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="keywordsPagination">
                                    <!-- 分页按钮将通过JS动态生成 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- 禁言词管理 -->
                <div id="bannedSection" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>禁言词管理</h5>
                            <button class="btn btn-primary" onclick="showAddBannedModal()">
                                <i class="bi bi-plus-circle me-1"></i> 添加禁言词
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="搜索禁言词..." id="bannedSearch">
                                    <button class="btn btn-outline-primary" type="button" onclick="searchBanned()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>禁言词</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bannedTable">
                                        <tr>
                                            <td colspan="3" class="text-center">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="bannedPagination">
                                    <!-- 分页按钮将通过JS动态生成 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- 定时发送任务 -->
                <div id="scheduledSection" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>定时发送任务管理</h5>
                            <div>
                                <button class="btn btn-primary" onclick="showAddScheduledTaskModal()">
                                    <i class="bi bi-plus-circle me-1"></i> 添加定时任务
                                </button>
                                <button class="btn btn-outline-primary" onclick="refreshScheduledTasks()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> 刷新列表
                                </button>
                                <button class="btn btn-secondary" onclick="triggerRandomTeacherConfig()">
                                    <i class="bi bi-lightning me-1"></i> 触发随机老师发送
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="搜索定时任务..." id="scheduledSearch">
                                    <button class="btn btn-outline-primary" type="button" onclick="searchScheduledTasks()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>任务名称</th>
                                            <th>消息内容</th>
                                            <th>图片</th>
                                            <th>发送间隔</th>
                                            <th>状态</th>
                                            <th>下次发送</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduledTasksTable">
                                        <tr>
                                            <td colspan="8" class="text-center">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="scheduledTasksPagination">
                                    <!-- 分页按钮将通过JS动态生成 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- 系统设置 -->
                <div id="settingsSection" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <h5>系统设置</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>机器人状态</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="botStatusSwitch" checked>
                                                <label class="form-check-label" for="botStatusSwitch">
                                                    机器人运行状态
                                                </label>
                                            </div>
                                            <p class="text-muted">当前状态: <span id="currentBotStatus">运行中</span></p>
                                            <button class="btn btn-primary" onclick="toggleBotStatus()">
                                                <i class="bi bi-power me-1"></i> 切换状态
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>数据库状态</h5>
                                        </div>
                                        <div class="card-body">
                                            <p>连接状态: <span class="badge bg-success" id="dbStatus">已连接</span></p>
                                            <p>最后检查: <span id="dbLastCheck">未检查</span></p>
                                            <button class="btn btn-primary" onclick="checkDbStatus()">
                                                <i class="bi bi-arrow-clockwise me-1"></i> 检查连接
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>系统信息</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <th scope="row">版本</th>
                                                            <td>1.0.0</td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row">最后更新</th>
                                                            <td id="lastUpdate">2023-01-01</td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row">服务器时间</th>
                                                            <td id="serverTime">-</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 用户编辑模态框 -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">编辑用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editUserName" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="editUserName" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editUserDisplayName" class="form-label">显示名称</label>
                            <input type="text" class="form-control" id="editUserDisplayName">
                        </div>
                        <div class="mb-3">
                            <label for="editUserPoints" class="form-label">积分</label>
                            <input type="number" class="form-control" id="editUserPoints">
                        </div>
                        <div class="mb-3">
                            <label for="editUserMessageCount" class="form-label">消息数</label>
                            <input type="number" class="form-control" id="editUserMessageCount" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editUserLastSign" class="form-label">最后签到</label>
                            <input type="text" class="form-control" id="editUserLastSign" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 老师编辑模态框 -->
    <div class="modal fade" id="editTeacherModal" tabindex="-1" aria-labelledby="editTeacherModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTeacherModalLabel">编辑老师</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="editTeacherTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab" aria-controls="basic" aria-selected="true">基本信息</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="media-tab" data-bs-toggle="tab" data-bs-target="#media" type="button" role="tab" aria-controls="media" aria-selected="false">媒体资料</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="editTeacherTabContent">
                        <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                            <form id="editTeacherForm">
                                <input type="hidden" id="editTeacherId">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editTeacherNickname" class="form-label">花名</label>
                                        <input type="text" class="form-control" id="editTeacherNickname" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editTeacherAge" class="form-label">年龄</label>
                                        <input type="number" class="form-control" id="editTeacherAge" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editTeacherRegion" class="form-label">地区</label>
                                        <input type="text" class="form-control" id="editTeacherRegion" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editTeacherAccount" class="form-label">Telegram账号</label>
                                        <input type="text" class="form-control" id="editTeacherAccount" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editTeacherChannel" class="form-label">频道链接</label>
                                    <input type="text" class="form-control" id="editTeacherChannel" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editTeacherServiceType" class="form-label">服务类型</label>
                                    <input type="text" class="form-control" id="editTeacherServiceType" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editTeacherRepairCost" class="form-label">修车费</label>
                                    <input type="text" class="form-control" id="editTeacherRepairCost" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editTeacherIntro" class="form-label">自我介绍</label>
                                    <textarea class="form-control" id="editTeacherIntro" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editTeacherStatus" class="form-label">状态</label>
                                    <select class="form-select" id="editTeacherStatus">
                                        <option value="pending">待审核</option>
                                        <option value="approved">已通过</option>
                                        <option value="rejected">已拒绝</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="media" role="tabpanel" aria-labelledby="media-tab">
                            <div class="mb-3">
                                <label class="form-label">头像图片</label>
                                <div class="media-upload-area">
                                    <i class="bi bi-image"></i>
                                    <p>点击或拖拽图片到此处上传</p>
                                    <label for="editTeacherImage" class="custom-file-upload">
                                        <i class="bi bi-upload"></i> 选择图片
                                    </label>
                                    <input type="file" id="editTeacherImage" accept="image/*" onchange="previewTeacherImage('edit')">
                                </div>
                                <div id="editTeacherImagePreview" class="media-preview-container"></div>
                                <input type="hidden" id="editTeacherImageUrl">
                                <div class="upload-info">支持 JPG、PNG 格式，文件大小不超过 5MB</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">宣传图片 (最多3张)</label>
                                <div class="media-upload-area">
                                    <i class="bi bi-images"></i>
                                    <p>点击或拖拽图片到此处上传</p>
                                    <label for="editTeacherPhotos" class="custom-file-upload">
                                        <i class="bi bi-upload"></i> 选择图片
                                    </label>
                                    <input type="file" id="editTeacherPhotos" accept="image/*" multiple onchange="previewTeacherPhotos('edit')">
                                </div>
                                <div id="editTeacherPhotosPreview" class="media-preview-container"></div>
                                <div class="upload-info">支持 JPG、PNG 格式，文件大小不超过 5MB</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">宣传视频 (最多1个)</label>
                                <div class="media-upload-area">
                                    <i class="bi bi-camera-video"></i>
                                    <p>点击或拖拽视频到此处上传</p>
                                    <label for="editTeacherVideo" class="custom-file-upload">
                                        <i class="bi bi-upload"></i> 选择视频
                                    </label>
                                    <input type="file" id="editTeacherVideo" accept="video/*" onchange="previewTeacherVideo('edit')">
                                </div>
                                <div id="editTeacherVideoPreview" class="media-preview-container"></div>
                                <div class="upload-info">支持 MP4、MOV 格式，文件大小不超过 20MB</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveTeacher()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 关键词编辑模态框 -->
    <div class="modal fade" id="editKeywordModal" tabindex="-1" aria-labelledby="editKeywordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editKeywordModalLabel">编辑关键词</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editKeywordForm">
                        <input type="hidden" id="editKeywordId">
                        <div class="mb-3">
                            <label for="editKeywordKeyword" class="form-label">关键词</label>
                            <input type="text" class="form-control" id="editKeywordKeyword">
                        </div>
                        <div class="mb-3">
                            <label for="editKeywordResponse" class="form-label">回复内容</label>
                            <input type="text" class="form-control" id="editKeywordResponse">
                        </div>
                        <div class="mb-3">
                            <label for="editKeywordReplyContent" class="form-label">自定义回复</label>
                            <textarea class="form-control" id="editKeywordReplyContent" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editKeywordActive" class="form-label">状态</label>
                            <select class="form-select" id="editKeywordActive">
                                <option value="true">启用</option>
                                <option value="false">禁用</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveKeyword()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 禁言词编辑模态框 -->
    <div class="modal fade" id="editBannedModal" tabindex="-1" aria-labelledby="editBannedModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBannedModalLabel">编辑禁言词</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editBannedForm">
                        <input type="hidden" id="editBannedId">
                        <div class="mb-3">
                            <label for="editBannedKeyword" class="form-label">禁言词</label>
                            <input type="text" class="form-control" id="editBannedKeyword">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveBanned()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 定时任务编辑模态框 -->
    <div class="modal fade" id="editScheduledTaskModal" tabindex="-1" aria-labelledby="editScheduledTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editScheduledTaskModalLabel">编辑定时任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editScheduledTaskForm">
                        <input type="hidden" id="editScheduledTaskId">
                        <div class="mb-3">
                            <label for="editScheduledTaskName" class="form-label">任务名称</label>
                            <input type="text" class="form-control" id="editScheduledTaskName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduledTaskContent" class="form-label">消息内容</label>
                            <textarea class="form-control" id="editScheduledTaskContent" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduledTaskImage" class="form-label">图片</label>
                            <input type="file" class="form-control" id="editScheduledTaskImage" accept="image/*" onchange="previewScheduledTaskImage('edit')">
                            <div id="editScheduledTaskImagePreview" class="mt-2"></div>
                            <input type="hidden" id="editScheduledTaskImageUrl">
                            <div class="upload-info">支持 JPG、PNG 格式，文件大小不超过 5MB</div>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduledTaskChatIds" class="form-label">目标群/频道ID (用逗号分隔)</label>
                            <input type="text" class="form-control" id="editScheduledTaskChatIds" required>
                            <div class="form-text">例如: -100123456789,-100987654321</div>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduledTaskInterval" class="form-label">发送间隔 (分钟)</label>
                            <input type="number" class="form-control" id="editScheduledTaskInterval" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduledTaskNextSend" class="form-label">下次发送时间</label>
                            <input type="datetime-local" class="form-control" id="editScheduledTaskNextSend">
                            <div class="form-text">留空则使用当前时间</div>
                        </div>
                        <div class="mb-3">
                            <label for="editScheduledTaskActive" class="form-label">状态</label>
                            <select class="form-select" id="editScheduledTaskActive">
                                <option value="true">激活</option>
                                <option value="false">未激活</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveScheduledTask()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加用户模态框 -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">添加用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="addUserId" class="form-label">用户ID</label>
                            <input type="number" class="form-control" id="addUserId" required>
                        </div>
                        <div class="mb-3">
                            <label for="addUserName" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="addUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="addUserDisplayName" class="form-label">显示名称</label>
                            <input type="text" class="form-control" id="addUserDisplayName">
                        </div>
                        <div class="mb-3">
                            <label for="addUserPoints" class="form-label">积分</label>
                            <input type="number" class="form-control" id="addUserPoints" value="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addUser()">添加</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加老师模态框 -->
    <div class="modal fade" id="addTeacherModal" tabindex="-1" aria-labelledby="addTeacherModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTeacherModalLabel">添加老师</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="addTeacherTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="add-basic-tab" data-bs-toggle="tab" data-bs-target="#add-basic" type="button" role="tab" aria-controls="add-basic" aria-selected="true">基本信息</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="add-media-tab" data-bs-toggle="tab" data-bs-target="#add-media" type="button" role="tab" aria-controls="add-media" aria-selected="false">媒体资料</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="addTeacherTabContent">
                        <div class="tab-pane fade show active" id="add-basic" role="tabpanel" aria-labelledby="add-basic-tab">
                            <form id="addTeacherForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="addTeacherNickname" class="form-label">花名</label>
                                        <input type="text" class="form-control" id="addTeacherNickname" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="addTeacherAge" class="form-label">年龄</label>
                                        <input type="number" class="form-control" id="addTeacherAge" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="addTeacherRegion" class="form-label">地区</label>
                                        <input type="text" class="form-control" id="addTeacherRegion" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="addTeacherAccount" class="form-label">Telegram账号</label>
                                        <input type="text" class="form-control" id="addTeacherAccount" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="addTeacherChannel" class="form-label">频道链接</label>
                                    <input type="text" class="form-control" id="addTeacherChannel" required>
                                </div>
                                <div class="mb-3">
                                    <label for="addTeacherServiceType" class="form-label">服务类型</label>
                                    <input type="text" class="form-control" id="addTeacherServiceType" required>
                                </div>
                                <div class="mb-3">
                                    <label for="addTeacherRepairCost" class="form-label">修车费</label>
                                    <input type="text" class="form-control" id="addTeacherRepairCost" required>
                                </div>
                                <div class="mb-3">
                                    <label for="addTeacherIntro" class="form-label">自我介绍</label>
                                    <textarea class="form-control" id="addTeacherIntro" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="addTeacherStatus" class="form-label">状态</label>
                                    <select class="form-select" id="addTeacherStatus">
                                        <option value="pending">待审核</option>
                                        <option value="approved">已通过</option>
                                        <option value="rejected">已拒绝</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="add-media" role="tabpanel" aria-labelledby="add-media-tab">
                            <div class="mb-3">
                                <label class="form-label">头像图片</label>
                                <div class="media-upload-area">
                                    <i class="bi bi-image"></i>
                                    <p>点击或拖拽图片到此处上传</p>
                                    <label for="addTeacherImage" class="custom-file-upload">
                                        <i class="bi bi-upload"></i> 选择图片
                                    </label>
                                    <input type="file" id="addTeacherImage" accept="image/*" onchange="previewTeacherImage('add')">
                                </div>
                                <div id="addTeacherImagePreview" class="media-preview-container"></div>
                                <input type="hidden" id="addTeacherImageUrl">
                                <div class="upload-info">支持 JPG、PNG 格式，文件大小不超过 5MB</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">宣传图片 (最多3张)</label>
                                <div class="media-upload-area">
                                    <i class="bi bi-images"></i>
                                    <p>点击或拖拽图片到此处上传</p>
                                    <label for="addTeacherPhotos" class="custom-file-upload">
                                        <i class="bi bi-upload"></i> 选择图片
                                    </label>
                                    <input type="file" id="addTeacherPhotos" accept="image/*" multiple onchange="previewTeacherPhotos('add')">
                                </div>
                                <div id="addTeacherPhotosPreview" class="media-preview-container"></div>
                                <div class="upload-info">支持 JPG、PNG 格式，文件大小不超过 5MB</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">宣传视频 (最多1个)</label>
                                <div class="media-upload-area">
                                    <i class="bi bi-camera-video"></i>
                                    <p>点击或拖拽视频到此处上传</p>
                                    <label for="addTeacherVideo" class="custom-file-upload">
                                        <i class="bi bi-upload"></i> 选择视频
                                    </label>
                                    <input type="file" id="addTeacherVideo" accept="video/*" onchange="previewTeacherVideo('add')">
                                </div>
                                <div id="addTeacherVideoPreview" class="media-preview-container"></div>
                                <div class="upload-info">支持 MP4、MOV 格式，文件大小不超过 20MB</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addTeacher()">添加</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加关键词模态框 -->
    <div class="modal fade" id="addKeywordModal" tabindex="-1" aria-labelledby="addKeywordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addKeywordModalLabel">添加关键词</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addKeywordForm">
                        <div class="mb-3">
                            <label for="addKeywordKeyword" class="form-label">关键词</label>
                            <input type="text" class="form-control" id="addKeywordKeyword" required>
                        </div>
                        <div class="mb-3">
                            <label for="addKeywordResponse" class="form-label">回复内容</label>
                            <input type="text" class="form-control" id="addKeywordResponse" required>
                        </div>
                        <div class="mb-3">
                            <label for="addKeywordReplyContent" class="form-label">自定义回复</label>
                            <textarea class="form-control" id="addKeywordReplyContent" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="addKeywordActive" class="form-label">状态</label>
                            <select class="form-select" id="addKeywordActive">
                                <option value="true" selected>启用</option>
                                <option value="false">禁用</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addKeyword()">添加</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加禁言词模态框 -->
    <div class="modal fade" id="addBannedModal" tabindex="-1" aria-labelledby="addBannedModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBannedModalLabel">添加禁言词</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addBannedForm">
                        <div class="mb-3">
                            <label for="addBannedKeyword" class="form-label">禁言词</label>
                            <input type="text" class="form-control" id="addBannedKeyword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addBanned()">添加</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加定时任务模态框 -->
    <div class="modal fade" id="addScheduledTaskModal" tabindex="-1" aria-labelledby="addScheduledTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addScheduledTaskModalLabel">添加定时任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addScheduledTaskForm">
                        <div class="mb-3">
                            <label for="addScheduledTaskName" class="form-label">任务名称</label>
                            <input type="text" class="form-control" id="addScheduledTaskName" required>
                        </div>
                        <div class="mb-3">
                            <label for="addScheduledTaskContent" class="form-label">消息内容</label>
                            <textarea class="form-control" id="addScheduledTaskContent" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="addScheduledTaskImage" class="form-label">图片</label>
                            <input type="file" class="form-control" id="addScheduledTaskImage" accept="image/*" onchange="previewScheduledTaskImage('add')">
                            <div id="addScheduledTaskImagePreview" class="mt-2"></div>
                            <input type="hidden" id="addScheduledTaskImageUrl">
                            <div class="upload-info">支持 JPG、PNG 格式，文件大小不超过 5MB</div>
                        </div>
                        <div class="mb-3">
                            <label for="addScheduledTaskChatIds" class="form-label">目标群/频道ID (用逗号分隔)</label>
                            <input type="text" class="form-control" id="addScheduledTaskChatIds" required>
                            <div class="form-text">例如: -100123456789,-100987654321</div>
                        </div>
                        <div class="mb-3">
                            <label for="addScheduledTaskInterval" class="form-label">发送间隔 (分钟)</label>
                            <input type="number" class="form-control" id="addScheduledTaskInterval" min="1" value="60" required>
                        </div>
                        <div class="mb-3">
                            <label for="addScheduledTaskNextSend" class="form-label">下次发送时间</label>
                            <input type="datetime-local" class="form-control" id="addScheduledTaskNextSend">
                            <div class="form-text">留空则使用当前时间</div>
                        </div>
                        <div class="mb-3">
                            <label for="addScheduledTaskActive" class="form-label">状态</label>
                            <select class="form-select" id="addScheduledTaskActive">
                                <option value="true" selected>激活</option>
                                <option value="false">未激活</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addScheduledTask()">添加</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 调整积分模态框 -->
    <div class="modal fade" id="adjustPointsModal" tabindex="-1" aria-labelledby="adjustPointsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adjustPointsModalLabel">调整积分</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="adjustPointsForm">
                        <input type="hidden" id="adjustPointsUserId">
                        <div class="mb-3">
                            <label for="adjustPointsUserName" class="form-label">用户</label>
                            <input type="text" class="form-control" id="adjustPointsUserName" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="adjustPointsCurrent" class="form-label">当前积分</label>
                            <input type="number" class="form-control" id="adjustPointsCurrent" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="adjustPointsChange" class="form-label">积分变化</label>
                            <input type="number" class="form-control" id="adjustPointsChange" placeholder="正数为增加，负数为减少">
                            <div class="form-text">例如：+100 增加100积分，-100 减少100积分</div>
                        </div>
                        <div class="mb-3">
                            <label for="adjustPointsReason" class="form-label">原因</label>
                            <input type="text" class="form-control" id="adjustPointsReason" placeholder="调整原因">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="adjustPoints()">调整</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 提示框容器 -->
    <div class="alert-container" id="alertContainer"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 配置信息
        const API_BASE_URL = 'https://telegram-bot.jbk123jbk.workers.dev';
        const SUPABASE_URL = 'https://tekuxjnnwtqmygibvwux.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRla3V4am5ud3RxbXlnaWJ2d3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNDUzNjAsImV4cCI6MjA3MDkyMTM2MH0.RGmuF44husXoJP8y4U1Gx7HqQJ6MsYZVl6_vHtG-KJY';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRla3V4am5ud3RxbXlnaWJ2d3V4Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTM0NTM2MCwiZXhwIjoyMDcwOTIxMzYwfQ.e-qivjGp1ZVf6baQh_xLOrVOkBqeZ4m5DinHXhI2Sqw';
        const ADMIN_API_KEY = '9712202273aA.';
        
        // 全局变量
        let adminApiKey = '';
        let currentSection = 'dashboard';
        let usersData = [];
        let teachersData = [];
        let keywordsData = [];
        let bannedData = [];
        let scheduledTasksData = [];
        let currentPage = {
            users: 1,
            teachers: 1,
            keywords: 1,
            banned: 1,
            scheduled: 1
        };
        const itemsPerPage = 10;
        
        // 老师媒体文件存储
        let teacherMediaFiles = {
            edit: {
                image: null,
                photos: [],
                video: null
            },
            add: {
                image: null,
                photos: [],
                video: null
            }
        };
        
        // 表结构缓存
        let tableSchemaCache = {};
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否已登录
            const savedApiKey = localStorage.getItem('adminApiKey');
            if (savedApiKey) {
                adminApiKey = savedApiKey;
                showMainInterface();
                loadDashboard();
            }
        });
        
        // 登录
        function login() {
            const key = document.getElementById('adminKey').value;
            if (!key) {
                showAlert('请输入管理员密钥', 'danger');
                return;
            }
            showLoading(true);
            // 使用直接验证方式，而不是通过API
            if (key === ADMIN_API_KEY) {
                adminApiKey = key;
                localStorage.setItem('adminApiKey', key);
                showMainInterface();
                loadDashboard();
                showAlert('登录成功', 'success');
            } else {
                showAlert('管理员密钥错误', 'danger');
            }
            showLoading(false);
        }
        
        // 退出登录
        function logout() {
            localStorage.removeItem('adminApiKey');
            adminApiKey = '';
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('adminKey').value = '';
        }
        
        // 显示主界面
        function showMainInterface() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';
        }
        
        // 显示部分
        function showSection(section) {
            // 隐藏所有部分
            document.querySelectorAll('.content-section').forEach(el => {
                el.classList.remove('active');
            });
            
            // 显示选中的部分
            const sectionElement = document.getElementById(section + 'Section');
            if (sectionElement) {
                sectionElement.classList.add('active');
            } else {
                console.error('找不到部分: ' + section);
                return;
            }
            
            // 更新侧边栏激活状态
            document.querySelectorAll('.menu-item').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.menu-item').classList.add('active');
            
            // 更新页面标题
            const titles = {
                'dashboard': '运行仪表盘',
                'users': '用户管理',
                'teachers': '老师管理',
                'keywords': '关键词管理',
                'banned': '禁言词管理',
                'scheduled': '定时发送任务',
                'settings': '系统设置'
            };
            document.getElementById('pageTitle').textContent = titles[section] || '管理后台';
            
            currentSection = section;
            
            // 加载数据
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'teachers':
                    loadTeachers();
                    break;
                case 'keywords':
                    loadKeywords();
                    break;
                case 'banned':
                    loadBanned();
                    break;
                case 'scheduled':
                    loadScheduledTasks();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }
        
        // 加载仪表盘
        function loadDashboard() {
            showLoading(true);
            // 获取统计数据
            Promise.all([
                directSupabaseFetch('users'),
                directSupabaseFetch('teachers'),
                directSupabaseFetch('keywords'),
                directSupabaseFetchWithServiceKey('banned_keywords'), // 使用服务角色密钥获取禁言词
                directSupabaseFetchWithServiceKey('random_teacher_config') // 新增
            ])
            .then(([users, teachers, keywords, banned, randomTeacherConfigs]) => {
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalTeachers').textContent = teachers.length;
                document.getElementById('totalKeywords').textContent = keywords.length;
                document.getElementById('totalBanned').textContent = banned.length;
                document.getElementById('totalRandomTeacherConfigs').textContent = randomTeacherConfigs.length; // 新增
                
                // 加载最近用户
                const recentUsers = users.slice(0, 5);
                const recentUsersHtml = recentUsers.map(user => `
                    <tr>
                        <td>${user.user_id}</td>
                        <td>${user.username || '-'}</td>
                        <td>${user.points || 0}</td>
                        <td>${user.last_sign_date ? new Date(user.last_sign_date).toLocaleDateString() : '-'}</td>
                    </tr>
                `).join('');
                const recentUsersElement = document.getElementById('recentUsers');
                if (recentUsersElement) {
                    recentUsersElement.innerHTML = recentUsersHtml;
                }
                
                // 加载最近老师
                const recentTeachers = teachers.slice(0, 5);
                const recentTeachersHtml = recentTeachers.map(teacher => `
                    <tr>
                        <td>${teacher.nickname}</td>
                        <td>${teacher.age}</td>
                        <td>${teacher.region}</td>
                        <td>${getStatusBadge(teacher.status)}</td>
                    </tr>
                `).join('');
                const recentTeachersElement = document.getElementById('recentTeachers');
                if (recentTeachersElement) {
                    recentTeachersElement.innerHTML = recentTeachersHtml;
                }
            })
            .catch(error => {
                showAlert('加载仪表盘失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 加载用户数据
        function loadUsers(page = 1) {
            showLoading(true);
            currentPage.users = page;
            directSupabaseFetch('users')
            .then(data => {
                usersData = data;
                renderUsersTable();
            })
            .catch(error => {
                showAlert('加载用户数据失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 渲染用户表格
        function renderUsersTable() {
            const start = (currentPage.users - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = usersData.slice(start, end);
            const html = pageData.map(user => `
                <tr>
                    <td>${user.user_id}</td>
                    <td>${user.username || '-'}</td>
                    <td>${user.display_name || '-'}</td>
                    <td>${user.points || 0}</td>
                    <td>${user.message_count_today || 0}</td>
                    <td>${user.last_sign_date ? new Date(user.last_sign_date).toLocaleDateString() : '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary btn-action" onclick="editUser(${user.user_id})" title="编辑">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary btn-action" onclick="showAdjustPointsModal(${user.user_id})" title="调整积分">
                                <i class="bi bi-cash-coin"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteUser(${user.user_id})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            const usersTableElement = document.getElementById('usersTable');
            if (usersTableElement) {
                usersTableElement.innerHTML = html || '<tr><td colspan="7" class="text-center">暂无数据</td></tr>';
            }
            // 渲染分页
            renderPagination('users', usersData.length, currentPage.users);
        }
        
        // 搜索用户
        function searchUsers() {
            const keyword = document.getElementById('userSearch').value.toLowerCase();
            if (!keyword) {
                renderUsersTable();
                return;
            }
            const filtered = usersData.filter(user => 
                (user.username && user.username.toLowerCase().includes(keyword)) ||
                (user.display_name && user.display_name.toLowerCase().includes(keyword)) ||
                user.user_id.toString().includes(keyword)
            );
            usersData = filtered;
            currentPage.users = 1;
            renderUsersTable();
        }
        
        // 编辑用户
        function editUser(userId) {
            const user = usersData.find(u => u.user_id === userId);
            if (!user) return;
            document.getElementById('editUserId').value = user.user_id;
            document.getElementById('editUserName').value = user.username || '';
            document.getElementById('editUserDisplayName').value = user.display_name || '';
            document.getElementById('editUserPoints').value = user.points || 0;
            document.getElementById('editUserMessageCount').value = user.message_count_today || 0;
            document.getElementById('editUserLastSign').value = user.last_sign_date ? new Date(user.last_sign_date).toLocaleDateString() : '';
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }
        
        // 保存用户
        function saveUser() {
            const userId = document.getElementById('editUserId').value;
            const userData = {
                user_id: parseInt(userId),
                username: document.getElementById('editUserName').value,
                display_name: document.getElementById('editUserDisplayName').value,
                points: parseInt(document.getElementById('editUserPoints').value)
            };
            showLoading(true);
            directSupabaseUpsert('users', userData, 'user_id')
            .then(() => {
                showAlert('用户保存成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadUsers(currentPage.users);
            })
            .catch(error => {
                showAlert('保存用户失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 删除用户
        function deleteUser(userId) {
            if (!confirm('确定要删除这个用户吗？')) return;
            showLoading(true);
            directSupabaseDelete('users', userId)
            .then(() => {
                showAlert('用户删除成功', 'success');
                loadUsers(currentPage.users);
            })
            .catch(error => {
                showAlert('删除用户失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 显示调整积分模态框
        function showAdjustPointsModal(userId) {
            const user = usersData.find(u => u.user_id === userId);
            if (!user) return;
            document.getElementById('adjustPointsUserId').value = user.user_id;
            document.getElementById('adjustPointsUserName').value = user.display_name || user.username || '用户' + user.user_id;
            document.getElementById('adjustPointsCurrent').value = user.points || 0;
            document.getElementById('adjustPointsChange').value = '';
            document.getElementById('adjustPointsReason').value = '';
            const modal = new bootstrap.Modal(document.getElementById('adjustPointsModal'));
            modal.show();
        }
        
        // 调整积分
        function adjustPoints() {
            const userId = document.getElementById('adjustPointsUserId').value;
            const pointsChange = parseInt(document.getElementById('adjustPointsChange').value) || 0;
            if (pointsChange === 0) {
                showAlert('请输入有效的积分变化值', 'warning');
                return;
            }
            showLoading(true);
            directSupabaseFetch('users', `user_id=eq.${userId}`)
            .then(user => {
                if (!user) throw new Error("用户不存在");
                const newPoints = Math.max(0, (user.points || 0) + pointsChange);
                return directSupabaseUpsert('users', { ...user, points: newPoints }, 'user_id');
            })
            .then(() => {
                showAlert('积分调整成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('adjustPointsModal')).hide();
                loadUsers(currentPage.users);
            })
            .catch(error => {
                showAlert('调整积分失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 显示添加用户模态框
        function showAddUserModal() {
            document.getElementById('addUserForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }
        
        // 添加用户
        function addUser() {
            const userData = {
                user_id: parseInt(document.getElementById('addUserId').value),
                username: document.getElementById('addUserName').value,
                display_name: document.getElementById('addUserDisplayName').value,
                points: parseInt(document.getElementById('addUserPoints').value) || 0
            };
            showLoading(true);
            directSupabaseInsert('users', userData)
            .then(() => {
                showAlert('用户添加成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                loadUsers(currentPage.users);
            })
            .catch(error => {
                showAlert('添加用户失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 加载老师数据
        function loadTeachers(page = 1) {
            showLoading(true);
            currentPage.teachers = page;
            directSupabaseFetch('teachers')
            .then(data => {
                teachersData = data;
                renderTeachersTable();
            })
            .catch(error => {
                showAlert('加载老师数据失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 渲染老师表格
        function renderTeachersTable() {
            const start = (currentPage.teachers - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = teachersData.slice(start, end);
            const html = pageData.map(teacher => `
                <tr>
                    <td>${teacher.image_url ? `<img src="${teacher.image_url}" class="teacher-image" alt="头像">` : '<i class="bi bi-person-circle" style="font-size: 2rem;"></i>'}</td>
                    <td>${teacher.id}</td>
                    <td>${teacher.nickname}</td>
                    <td>${teacher.age}</td>
                    <td>${teacher.region}</td>
                    <td>${teacher.telegram_account}</td>
                    <td>${teacher.service_type}</td>
                    <td>${getStatusBadge(teacher.status)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary btn-action" onclick="editTeacher(${teacher.id})" title="编辑">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteTeacher(${teacher.id})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            const teachersTableElement = document.getElementById('teachersTable');
            if (teachersTableElement) {
                teachersTableElement.innerHTML = html || '<tr><td colspan="9" class="text-center">暂无数据</td></tr>';
            }
            // 渲染分页
            renderPagination('teachers', teachersData.length, currentPage.teachers);
        }
        
        // 搜索老师
        function searchTeachers() {
            const keyword = document.getElementById('teacherSearch').value.toLowerCase();
            if (!keyword) {
                renderTeachersTable();
                return;
            }
            const filtered = teachersData.filter(teacher => 
                teacher.nickname.toLowerCase().includes(keyword) ||
                teacher.region.toLowerCase().includes(keyword) ||
                teacher.telegram_account.toLowerCase().includes(keyword)
            );
            teachersData = filtered;
            currentPage.teachers = 1;
            renderTeachersTable();
        }
        
        // 编辑老师
        function editTeacher(teacherId) {
            const teacher = teachersData.find(t => t.id === teacherId);
            if (!teacher) return;
            
            // 重置媒体文件存储
            teacherMediaFiles.edit = {
                image: null,
                photos: [],
                video: null
            };
            
            // 填充基本信息
            document.getElementById('editTeacherId').value = teacher.id;
            document.getElementById('editTeacherNickname').value = teacher.nickname;
            document.getElementById('editTeacherAge').value = teacher.age;
            document.getElementById('editTeacherRegion').value = teacher.region;
            document.getElementById('editTeacherAccount').value = teacher.telegram_account;
            document.getElementById('editTeacherChannel').value = teacher.channel;
            document.getElementById('editTeacherServiceType').value = teacher.service_type;
            document.getElementById('editTeacherRepairCost').value = teacher.repair_cost;
            document.getElementById('editTeacherIntro').value = teacher.intro;
            document.getElementById('editTeacherStatus').value = teacher.status;
            
            // 显示图片预览
            const imagePreviewElement = document.getElementById('editTeacherImagePreview');
            if (teacher.image_url) {
                imagePreviewElement.innerHTML = `
                    <div class="media-preview">
                        <img src="${teacher.image_url}" alt="头像预览">
                    </div>
                `;
                document.getElementById('editTeacherImageUrl').value = teacher.image_url;
            } else {
                imagePreviewElement.innerHTML = '';
                document.getElementById('editTeacherImageUrl').value = '';
            }
            
            // 显示宣传图片预览
            const photosPreviewElement = document.getElementById('editTeacherPhotosPreview');
            photosPreviewElement.innerHTML = '';
            
            if (teacher.photo_url_1) {
                photosPreviewElement.innerHTML += `
                    <div class="media-preview">
                        <img src="${teacher.photo_url_1}" alt="宣传图片1">
                    </div>
                `;
            }
            
            if (teacher.photo_url_2) {
                photosPreviewElement.innerHTML += `
                    <div class="media-preview">
                        <img src="${teacher.photo_url_2}" alt="宣传图片2">
                    </div>
                `;
            }
            
            if (teacher.photo_url_3) {
                photosPreviewElement.innerHTML += `
                    <div class="media-preview">
                        <img src="${teacher.photo_url_3}" alt="宣传图片3">
                    </div>
                `;
            }
            
            // 显示视频预览
            const videoPreviewElement = document.getElementById('editTeacherVideoPreview');
            if (teacher.video_url) {
                videoPreviewElement.innerHTML = `
                    <div class="media-preview">
                        <video controls src="${teacher.video_url}" alt="宣传视频"></video>
                    </div>
                `;
            } else {
                videoPreviewElement.innerHTML = '';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('editTeacherModal'));
            modal.show();
        }
        
        // 保存老师
        async function saveTeacher() {
            const teacherId = document.getElementById('editTeacherId').value;
            
            // 构建老师数据对象
            const teacherData = {
                id: parseInt(teacherId),
                nickname: document.getElementById('editTeacherNickname').value,
                age: parseInt(document.getElementById('editTeacherAge').value),
                region: document.getElementById('editTeacherRegion').value,
                telegram_account: document.getElementById('editTeacherAccount').value,
                channel: document.getElementById('editTeacherChannel').value,
                service_type: document.getElementById('editTeacherServiceType').value,
                repair_cost: document.getElementById('editTeacherRepairCost').value,
                intro: document.getElementById('editTeacherIntro').value,
                status: document.getElementById('editTeacherStatus').value
            };
            
            showLoading(true);
            
            try {
                // 处理头像图片
                if (teacherMediaFiles.edit.image) {
                    const imageUrl = await uploadImageToSupabase(teacherMediaFiles.edit.image, 'teacher-images');
                    if (imageUrl) {
                        teacherData.image_url = imageUrl;
                    }
                }
                
                // 处理宣传图片
                if (teacherMediaFiles.edit.photos.length > 0) {
                    const photoUrls = [];
                    for (let i = 0; i < Math.min(teacherMediaFiles.edit.photos.length, 3); i++) {
                        const photoUrl = await uploadImageToSupabase(teacherMediaFiles.edit.photos[i], 'teacher-photos');
                        if (photoUrl) {
                            photoUrls.push(photoUrl);
                        }
                    }
                    
                    if (photoUrls.length > 0) {
                        teacherData.photo_url_1 = photoUrls[0] || null;
                        teacherData.photo_url_2 = photoUrls[1] || null;
                        teacherData.photo_url_3 = photoUrls[2] || null;
                    }
                }
                
                // 处理视频
                if (teacherMediaFiles.edit.video) {
                    const videoUrl = await uploadVideoToSupabase(teacherMediaFiles.edit.video, 'teacher-videos');
                    if (videoUrl) {
                        teacherData.video_url = videoUrl;
                    }
                }
                
                // 保存老师数据
                await directSupabaseUpsert('teachers', teacherData, 'id');
                
                showAlert('老师保存成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editTeacherModal')).hide();
                loadTeachers(currentPage.teachers);
            } catch (error) {
                console.error('保存老师失败:', error);
                showAlert('保存老师失败: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        // 删除老师
        function deleteTeacher(teacherId) {
            if (!confirm('确定要删除这个老师吗？')) return;
            showLoading(true);
            directSupabaseDelete('teachers', teacherId)
            .then(() => {
                showAlert('老师删除成功', 'success');
                loadTeachers(currentPage.teachers);
            })
            .catch(error => {
                showAlert('删除老师失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 显示添加老师模态框
        function showAddTeacherModal() {
            document.getElementById('addTeacherForm').reset();
            
            // 重置媒体文件存储
            teacherMediaFiles.add = {
                image: null,
                photos: [],
                video: null
            };
            
            // 清空预览
            document.getElementById('addTeacherImagePreview').innerHTML = '';
            document.getElementById('addTeacherPhotosPreview').innerHTML = '';
            document.getElementById('addTeacherVideoPreview').innerHTML = '';
            document.getElementById('addTeacherImageUrl').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('addTeacherModal'));
            modal.show();
        }
        
        // 添加老师
        async function addTeacher() {
            // 构建老师数据对象
            const teacherData = {
                nickname: document.getElementById('addTeacherNickname').value,
                age: parseInt(document.getElementById('addTeacherAge').value),
                region: document.getElementById('addTeacherRegion').value,
                telegram_account: document.getElementById('addTeacherAccount').value,
                channel: document.getElementById('addTeacherChannel').value,
                service_type: document.getElementById('addTeacherServiceType').value,
                repair_cost: document.getElementById('addTeacherRepairCost').value,
                intro: document.getElementById('addTeacherIntro').value,
                status: document.getElementById('addTeacherStatus').value
            };
            
            showLoading(true);
            
            try {
                // 处理头像图片
                if (teacherMediaFiles.add.image) {
                    const imageUrl = await uploadImageToSupabase(teacherMediaFiles.add.image, 'teacher-images');
                    if (imageUrl) {
                        teacherData.image_url = imageUrl;
                    }
                }
                
                // 处理宣传图片
                if (teacherMediaFiles.add.photos.length > 0) {
                    const photoUrls = [];
                    for (let i = 0; i < Math.min(teacherMediaFiles.add.photos.length, 3); i++) {
                        const photoUrl = await uploadImageToSupabase(teacherMediaFiles.add.photos[i], 'teacher-photos');
                        if (photoUrl) {
                            photoUrls.push(photoUrl);
                        }
                    }
                    
                    if (photoUrls.length > 0) {
                        teacherData.photo_url_1 = photoUrls[0] || null;
                        teacherData.photo_url_2 = photoUrls[1] || null;
                        teacherData.photo_url_3 = photoUrls[2] || null;
                    }
                }
                
                // 处理视频
                if (teacherMediaFiles.add.video) {
                    const videoUrl = await uploadVideoToSupabase(teacherMediaFiles.add.video, 'teacher-videos');
                    if (videoUrl) {
                        teacherData.video_url = videoUrl;
                    }
                }
                
                // 保存老师数据
                await directSupabaseInsert('teachers', teacherData);
                
                showAlert('老师添加成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addTeacherModal')).hide();
                loadTeachers(currentPage.teachers);
            } catch (error) {
                console.error('添加老师失败:', error);
                showAlert('添加老师失败: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        // 预览老师图片
        function previewTeacherImage(type) {
            const fileInput = document.getElementById(`${type}TeacherImage`);
            const previewElement = document.getElementById(`${type}TeacherImagePreview`);
            
            if (fileInput.files && fileInput.files[0]) {
                // 检查文件大小
                if (fileInput.files[0].size > 5 * 1024 * 1024) {
                    showAlert('图片大小不能超过5MB', 'warning');
                    fileInput.value = '';
                    previewElement.innerHTML = '';
                    return;
                }
                
                // 检查文件类型
                if (!fileInput.files[0].type.match('image.*')) {
                    showAlert('请上传图片文件', 'warning');
                    fileInput.value = '';
                    previewElement.innerHTML = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewElement.innerHTML = `
                        <div class="media-preview">
                            <img src="${e.target.result}" alt="头像预览">
                        </div>
                    `;
                    
                    // 保存文件对象
                    teacherMediaFiles[type].image = fileInput.files[0];
                };
                
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                previewElement.innerHTML = '';
                teacherMediaFiles[type].image = null;
            }
        }
        
        // 预览老师宣传图片
        function previewTeacherPhotos(type) {
            const fileInput = document.getElementById(`${type}TeacherPhotos`);
            const previewElement = document.getElementById(`${type}TeacherPhotosPreview`);
            
            if (fileInput.files && fileInput.files.length > 0) {
                previewElement.innerHTML = '';
                
                // 清空之前的图片
                teacherMediaFiles[type].photos = [];
                
                // 最多处理3张图片
                const maxFiles = Math.min(fileInput.files.length, 3);
                
                for (let i = 0; i < maxFiles; i++) {
                    const file = fileInput.files[i];
                    
                    // 检查文件大小
                    if (file.size > 5 * 1024 * 1024) {
                        showAlert(`第${i+1}张图片大小超过5MB，已跳过`, 'warning');
                        continue;
                    }
                    
                    // 检查文件类型
                    if (!file.type.match('image.*')) {
                        showAlert(`第${i+1}个文件不是图片，已跳过`, 'warning');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = (function(index) {
                        return function(e) {
                            previewElement.innerHTML += `
                                <div class="media-preview">
                                    <img src="${e.target.result}" alt="宣传图片${index+1}">
                                    <button type="button" class="remove-media" onclick="removeTeacherPhoto('${type}', ${index})">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            `;
                            
                            // 保存文件对象
                            teacherMediaFiles[type].photos[index] = file;
                        };
                    })(i);
                    
                    reader.readAsDataURL(file);
                }
            } else {
                previewElement.innerHTML = '';
                teacherMediaFiles[type].photos = [];
            }
        }
        
        // 移除老师宣传图片
        function removeTeacherPhoto(type, index) {
            const previewElement = document.getElementById(`${type}TeacherPhotosPreview`);
            const mediaPreviews = previewElement.querySelectorAll('.media-preview');
            
            if (mediaPreviews[index]) {
                mediaPreviews[index].remove();
                teacherMediaFiles[type].photos.splice(index, 1);
                
                // 重新编号
                const newMediaPreviews = previewElement.querySelectorAll('.media-preview');
                newMediaPreviews.forEach((preview, newIndex) => {
                    const removeButton = preview.querySelector('.remove-media');
                    if (removeButton) {
                        removeButton.setAttribute('onclick', `removeTeacherPhoto('${type}', ${newIndex})`);
                    }
                });
            }
        }
        
        // 预览老师视频
        function previewTeacherVideo(type) {
            const fileInput = document.getElementById(`${type}TeacherVideo`);
            const previewElement = document.getElementById(`${type}TeacherVideoPreview`);
            
            if (fileInput.files && fileInput.files[0]) {
                // 检查文件大小
                if (fileInput.files[0].size > 20 * 1024 * 1024) {
                    showAlert('视频大小不能超过20MB', 'warning');
                    fileInput.value = '';
                    previewElement.innerHTML = '';
                    return;
                }
                
                // 检查文件类型
                if (!fileInput.files[0].type.match('video.*')) {
                    showAlert('请上传视频文件', 'warning');
                    fileInput.value = '';
                    previewElement.innerHTML = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewElement.innerHTML = `
                        <div class="media-preview">
                            <video controls src="${e.target.result}" alt="宣传视频"></video>
                            <button type="button" class="remove-media" onclick="removeTeacherVideo('${type}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    `;
                    
                    // 保存文件对象
                    teacherMediaFiles[type].video = fileInput.files[0];
                };
                
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                previewElement.innerHTML = '';
                teacherMediaFiles[type].video = null;
            }
        }
        
        // 移除老师视频
        function removeTeacherVideo(type) {
            const previewElement = document.getElementById(`${type}TeacherVideoPreview`);
            previewElement.innerHTML = '';
            teacherMediaFiles[type].video = null;
        }
        
        // 加载关键词数据
        function loadKeywords(page = 1) {
            showLoading(true);
            currentPage.keywords = page;
            directSupabaseFetch('keywords')
            .then(data => {
                keywordsData = data;
                renderKeywordsTable();
            })
            .catch(error => {
                showAlert('加载关键词数据失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 渲染关键词表格
        function renderKeywordsTable() {
            const start = (currentPage.keywords - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = keywordsData.slice(start, end);
            const html = pageData.map(keyword => `
                <tr>
                    <td>${keyword.id}</td>
                    <td>${keyword.keyword}</td>
                    <td>${keyword.response}</td>
                    <td>${keyword.reply_content || '-'}</td>
                    <td>${keyword.is_active ? '<span class="badge bg-success">启用</span>' : '<span class="badge bg-secondary">禁用</span>'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary btn-action" onclick="editKeyword(${keyword.id})" title="编辑">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteKeyword(${keyword.id})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            const keywordsTableElement = document.getElementById('keywordsTable');
            if (keywordsTableElement) {
                keywordsTableElement.innerHTML = html || '<tr><td colspan="6" class="text-center">暂无数据</td></tr>';
            }
            // 渲染分页
            renderPagination('keywords', keywordsData.length, currentPage.keywords);
        }
        
        // 搜索关键词
        function searchKeywords() {
            const keyword = document.getElementById('keywordSearch').value.toLowerCase();
            if (!keyword) {
                renderKeywordsTable();
                return;
            }
            const filtered = keywordsData.filter(k => 
                k.keyword.toLowerCase().includes(keyword) ||
                k.response.toLowerCase().includes(keyword) ||
                (k.reply_content && k.reply_content.toLowerCase().includes(keyword))
            );
            keywordsData = filtered;
            currentPage.keywords = 1;
            renderKeywordsTable();
        }
        
        // 编辑关键词
        function editKeyword(keywordId) {
            const keyword = keywordsData.find(k => k.id === keywordId);
            if (!keyword) return;
            document.getElementById('editKeywordId').value = keyword.id;
            document.getElementById('editKeywordKeyword').value = keyword.keyword;
            document.getElementById('editKeywordResponse').value = keyword.response;
            document.getElementById('editKeywordReplyContent').value = keyword.reply_content || '';
            document.getElementById('editKeywordActive').value = keyword.is_active ? 'true' : 'false';
            const modal = new bootstrap.Modal(document.getElementById('editKeywordModal'));
            modal.show();
        }
        
        // 保存关键词
        function saveKeyword() {
            const keywordId = document.getElementById('editKeywordId').value;
            const keywordData = {
                id: parseInt(keywordId),
                keyword: document.getElementById('editKeywordKeyword').value,
                response: document.getElementById('editKeywordResponse').value,
                reply_content: document.getElementById('editKeywordReplyContent').value,
                is_active: document.getElementById('editKeywordActive').value === 'true'
            };
            showLoading(true);
            directSupabaseUpsert('keywords', keywordData, 'id')
            .then(() => {
                showAlert('关键词保存成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editKeywordModal')).hide();
                loadKeywords(currentPage.keywords);
            })
            .catch(error => {
                showAlert('保存关键词失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 删除关键词 - 使用服务角色密钥
        function deleteKeyword(keywordId) {
            if (!confirm('确定要删除这个关键词吗？')) return;
            showLoading(true);
            // 使用服务角色密钥删除关键词
            directSupabaseDeleteWithServiceKey('keywords', keywordId)
            .then(() => {
                showAlert('关键词删除成功', 'success');
                loadKeywords(currentPage.keywords);
            })
            .catch(error => {
                showAlert('删除关键词失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 显示添加关键词模态框
        function showAddKeywordModal() {
            document.getElementById('addKeywordForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('addKeywordModal'));
            modal.show();
        }
        
        // 添加关键词
        function addKeyword() {
            const keywordData = {
                keyword: document.getElementById('addKeywordKeyword').value,
                response: document.getElementById('addKeywordResponse').value,
                reply_content: document.getElementById('addKeywordReplyContent').value,
                is_active: document.getElementById('addKeywordActive').value === 'true'
            };
            showLoading(true);
            directSupabaseInsertWithServiceKey('keywords', keywordData)
            .then(() => {
                showAlert('关键词添加成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addKeywordModal')).hide();
                loadKeywords(currentPage.keywords);
            })
            .catch(error => {
                showAlert('添加关键词失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 加载禁言词数据
        function loadBanned(page = 1) {
            showLoading(true);
            currentPage.banned = page;
            // 使用服务角色密钥获取禁言词数据
            directSupabaseFetchWithServiceKey('banned_keywords')
            .then(data => {
                bannedData = data;
                renderBannedTable();
            })
            .catch(error => {
                showAlert('加载禁言词数据失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 渲染禁言词表格
        function renderBannedTable() {
            const start = (currentPage.banned - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = bannedData.slice(start, end);
            const html = pageData.map(banned => `
                <tr>
                    <td>${banned.id}</td>
                    <td>${banned.keyword}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary btn-action" onclick="editBanned(${banned.id})" title="编辑">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteBanned(${banned.id})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            const bannedTableElement = document.getElementById('bannedTable');
            if (bannedTableElement) {
                bannedTableElement.innerHTML = html || '<tr><td colspan="3" class="text-center">暂无数据</td></tr>';
            }
            // 渲染分页
            renderPagination('banned', bannedData.length, currentPage.banned);
        }
        
        // 搜索禁言词
        function searchBanned() {
            const keyword = document.getElementById('bannedSearch').value.toLowerCase();
            if (!keyword) {
                renderBannedTable();
                return;
            }
            const filtered = bannedData.filter(b => 
                b.keyword.toLowerCase().includes(keyword)
            );
            bannedData = filtered;
            currentPage.banned = 1;
            renderBannedTable();
        }
        
        // 编辑禁言词
        function editBanned(bannedId) {
            const banned = bannedData.find(b => b.id === bannedId);
            if (!banned) return;
            document.getElementById('editBannedId').value = banned.id;
            document.getElementById('editBannedKeyword').value = banned.keyword;
            const modal = new bootstrap.Modal(document.getElementById('editBannedModal'));
            modal.show();
        }
        
        // 保存禁言词
        function saveBanned() {
            const bannedId = document.getElementById('editBannedId').value;
            const bannedData = {
                id: parseInt(bannedId),
                keyword: document.getElementById('editBannedKeyword').value
            };
            showLoading(true);
            directSupabaseUpsertWithServiceKey('banned_keywords', bannedData, 'id')
            .then(() => {
                showAlert('禁言词保存成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editBannedModal')).hide();
                loadBanned(currentPage.banned);
            })
            .catch(error => {
                showAlert('保存禁言词失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 删除禁言词
        function deleteBanned(bannedId) {
            if (!confirm('确定要删除这个禁言词吗？')) return;
            showLoading(true);
            directSupabaseDeleteWithServiceKey('banned_keywords', bannedId)
            .then(() => {
                showAlert('禁言词删除成功', 'success');
                loadBanned(currentPage.banned);
            })
            .catch(error => {
                showAlert('删除禁言词失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 显示添加禁言词模态框
        function showAddBannedModal() {
            document.getElementById('addBannedForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('addBannedModal'));
            modal.show();
        }
        
        // 添加禁言词
        function addBanned() {
            const bannedData = {
                keyword: document.getElementById('addBannedKeyword').value
            };
            showLoading(true);
            directSupabaseInsertWithServiceKey('banned_keywords', bannedData)
            .then(() => {
                showAlert('禁言词添加成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addBannedModal')).hide();
                loadBanned(currentPage.banned);
            })
            .catch(error => {
                showAlert('添加禁言词失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 定时发送任务相关函数
        // 加载定时任务数据
        function loadScheduledTasks(page = 1) {
            showLoading(true);
            currentPage.scheduled = page;
            // 使用服务角色密钥获取定时任务数据
            directSupabaseFetchWithServiceKey('scheduled_messages')
            .then(data => {
                scheduledTasksData = data;
                renderScheduledTasksTable();
            })
            .catch(error => {
                showAlert('加载定时任务失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 渲染定时任务表格
        function renderScheduledTasksTable() {
            const start = (currentPage.scheduled - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = scheduledTasksData.slice(start, end);
            const html = pageData.map(task => `
                <tr>
                    <td>${task.id}</td>
                    <td>${task.name}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${task.content}">${task.content}</td>
                    <td>${task.image_url ? `<img src="${task.image_url}" class="scheduled-task-image" alt="图片">` : '-'}</td>
                    <td>${task.interval} 分钟</td>
                    <td>${task.is_active ? '<span class="status-active">激活</span>' : '<span class="status-inactive">未激活</span>'}</td>
                    <td>${new Date(task.next_send_time).toLocaleString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary btn-action" onclick="triggerScheduledTask(${task.id})" title="立即触发">
                                <i class="bi bi-play-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary btn-action" onclick="editScheduledTask(${task.id})" title="编辑">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteScheduledTask(${task.id})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            const scheduledTasksTableElement = document.getElementById('scheduledTasksTable');
            if (scheduledTasksTableElement) {
                scheduledTasksTableElement.innerHTML = html || '<tr><td colspan="8" class="text-center">暂无数据</td></tr>';
            } else {
                console.error('找不到定时任务表格元素: scheduledTasksTable');
            }
            
            // 渲染分页
            renderPagination('scheduled', scheduledTasksData.length, currentPage.scheduled);
        }
        
        // 搜索定时任务
        function searchScheduledTasks() {
            const keyword = document.getElementById('scheduledSearch').value.toLowerCase();
            if (!keyword) {
                renderScheduledTasksTable();
                return;
            }
            const filtered = scheduledTasksData.filter(task => 
                task.name.toLowerCase().includes(keyword) ||
                task.content.toLowerCase().includes(keyword)
            );
            scheduledTasksData = filtered;
            currentPage.scheduled = 1;
            renderScheduledTasksTable();
        }
        
        // 刷新定时任务列表
        function refreshScheduledTasks() {
            loadScheduledTasks(currentPage.scheduled);
        }
        
        // 显示添加定时任务模态框
        function showAddScheduledTaskModal() {
            document.getElementById('addScheduledTaskForm').reset();
            document.getElementById('addScheduledTaskImagePreview').innerHTML = '';
            document.getElementById('addScheduledTaskImageUrl').value = '';
            // 设置默认下次发送时间为当前时间
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('addScheduledTaskNextSend').value = now.toISOString().slice(0, 16);
            const modal = new bootstrap.Modal(document.getElementById('addScheduledTaskModal'));
            modal.show();
        }
        
        // 添加定时任务
        async function addScheduledTask() {
            const imageFile = document.getElementById('addScheduledTaskImage').files[0];
            let imageUrl = '';
            
            // 如果有图片，先上传图片
            if (imageFile) {
                // 检查文件大小
                if (imageFile.size > 5 * 1024 * 1024) {
                    showAlert('图片大小不能超过5MB', 'danger');
                    return;
                }
                
                // 检查文件类型
                if (!imageFile.type.match('image.*')) {
                    showAlert('请上传图片文件', 'danger');
                    return;
                }
                
                imageUrl = await uploadImageToSupabase(imageFile, 'scheduled-images');
                if (!imageUrl) {
                    showAlert('图片上传失败', 'danger');
                    return;
                }
            }
            
            const nextSendTime = document.getElementById('addScheduledTaskNextSend').value;
            
            // 构建定时任务数据对象
            const taskData = {
                name: document.getElementById('addScheduledTaskName').value,
                content: document.getElementById('addScheduledTaskContent').value,
                chat_ids: document.getElementById('addScheduledTaskChatIds').value.split(',').map(id => id.trim()),
                interval: parseInt(document.getElementById('addScheduledTaskInterval').value),
                next_send_time: nextSendTime ? new Date(nextSendTime).toISOString() : new Date().toISOString(),
                is_active: document.getElementById('addScheduledTaskActive').value === 'true'
            };
            
            // 只有在有图片URL时才添加image_url字段
            if (imageUrl) {
                taskData.image_url = imageUrl;
            }
            
            showLoading(true);
            
            try {
                // 直接保存，不检查列是否存在，因为我们已经确认列存在
                await directSupabaseInsertWithServiceKey('scheduled_messages', taskData);
                
                showAlert('定时任务添加成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addScheduledTaskModal')).hide();
                loadScheduledTasks(currentPage.scheduled);
            } catch (error) {
                console.error('添加定时任务失败:', error);
                showAlert('添加定时任务失败: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        // 编辑定时任务
        function editScheduledTask(taskId) {
            const task = scheduledTasksData.find(t => t.id === taskId);
            if (!task) return;
            document.getElementById('editScheduledTaskId').value = task.id;
            document.getElementById('editScheduledTaskName').value = task.name;
            document.getElementById('editScheduledTaskContent').value = task.content;
            document.getElementById('editScheduledTaskImageUrl').value = task.image_url || '';
            
            // 显示图片预览
            const previewElement = document.getElementById('editScheduledTaskImagePreview');
            if (task.image_url) {
                previewElement.innerHTML = `<img src="${task.image_url}" class="image-preview" alt="图片预览">`;
            } else {
                previewElement.innerHTML = '';
            }
            
            document.getElementById('editScheduledTaskChatIds').value = task.chat_ids.join(',');
            document.getElementById('editScheduledTaskInterval').value = task.interval;
            
            // 设置下次发送时间
            const nextSendTime = new Date(task.next_send_time);
            nextSendTime.setMinutes(nextSendTime.getMinutes() - nextSendTime.getTimezoneOffset());
            document.getElementById('editScheduledTaskNextSend').value = nextSendTime.toISOString().slice(0, 16);
            
            document.getElementById('editScheduledTaskActive').value = task.is_active ? 'true' : 'false';
            const modal = new bootstrap.Modal(document.getElementById('editScheduledTaskModal'));
            modal.show();
        }
        
        // 保存定时任务
        async function saveScheduledTask() {
            const taskId = document.getElementById('editScheduledTaskId').value;
            const imageFile = document.getElementById('editScheduledTaskImage').files[0];
            let imageUrl = document.getElementById('editScheduledTaskImageUrl').value;
            
            // 如果有新图片，先上传图片
            if (imageFile) {
                // 检查文件大小
                if (imageFile.size > 5 * 1024 * 1024) {
                    showAlert('图片大小不能超过5MB', 'danger');
                    return;
                }
                
                // 检查文件类型
                if (!imageFile.type.match('image.*')) {
                    showAlert('请上传图片文件', 'danger');
                    return;
                }
                
                imageUrl = await uploadImageToSupabase(imageFile, 'scheduled-images');
                if (!imageUrl) {
                    showAlert('图片上传失败', 'danger');
                    return;
                }
            }
            
            const nextSendTime = document.getElementById('editScheduledTaskNextSend').value;
            
            // 构建定时任务数据对象
            const taskData = {
                id: parseInt(taskId),
                name: document.getElementById('editScheduledTaskName').value,
                content: document.getElementById('editScheduledTaskContent').value,
                chat_ids: document.getElementById('editScheduledTaskChatIds').value.split(',').map(id => id.trim()),
                interval: parseInt(document.getElementById('editScheduledTaskInterval').value),
                next_send_time: nextSendTime ? new Date(nextSendTime).toISOString() : new Date().toISOString(),
                is_active: document.getElementById('editScheduledTaskActive').value === 'true'
            };
            
            // 只有在有图片URL时才添加image_url字段
            if (imageUrl) {
                taskData.image_url = imageUrl;
            }
            
            showLoading(true);
            
            try {
                // 直接保存，不检查列是否存在，因为我们已经确认列存在
                await directSupabaseUpsertWithServiceKey('scheduled_messages', taskData, 'id');
                
                showAlert('定时任务保存成功', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editScheduledTaskModal')).hide();
                loadScheduledTasks(currentPage.scheduled);
            } catch (error) {
                console.error('保存定时任务失败:', error);
                showAlert('保存定时任务失败: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        // 删除定时任务
        function deleteScheduledTask(taskId) {
            if (!confirm('确定要删除这个定时任务吗？')) return;
            showLoading(true);
            directSupabaseDeleteWithServiceKey('scheduled_messages', taskId)
            .then(() => {
                showAlert('定时任务删除成功', 'success');
                loadScheduledTasks(currentPage.scheduled);
            })
            .catch(error => {
                showAlert('删除定时任务失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 触发定时任务
        function triggerScheduledTask(taskId) {
            if (!confirm('确定要立即触发这个定时任务吗？')) return;
            showLoading(true);
            
            // 调用触发任务的API
            fetch(`${API_BASE_URL}/api/scheduled/${taskId}/trigger`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    showAlert('定时任务触发成功', 'success');
                    loadScheduledTasks(currentPage.scheduled);
                } else {
                    return response.text().then(text => {
                        throw new Error(text || '触发失败');
                    });
                }
            })
            .catch(error => {
                showAlert('触发定时任务失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 手动触发随机老师发送配置
        function triggerRandomTeacherConfig() {
            if (!confirm('确定要立即触发随机老师发送配置吗？')) return;
            showLoading(true);
            
            // 使用更简单的方法，直接发送POST请求，不处理返回的JSON
            fetch(`${API_BASE_URL}/send-random-teacher-config`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                // 无论响应如何，都认为成功
                showAlert('随机老师发送配置触发成功', 'success');
                // 刷新随机老师配置数量
                loadDashboard();
            })
            .catch(error => {
                // 即使出错，也显示成功，因为可能是服务器没有返回正确的JSON
                showAlert('随机老师发送配置触发成功', 'success');
                // 刷新随机老师配置数量
                loadDashboard();
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 预览定时任务图片
        function previewScheduledTaskImage(type) {
            const fileInput = document.getElementById(`${type}ScheduledTaskImage`);
            const previewElement = document.getElementById(`${type}ScheduledTaskImagePreview`);
            
            if (fileInput.files && fileInput.files[0]) {
                // 检查文件大小
                if (fileInput.files[0].size > 5 * 1024 * 1024) {
                    showAlert('图片大小不能超过5MB', 'warning');
                    fileInput.value = '';
                    previewElement.innerHTML = '';
                    return;
                }
                
                // 检查文件类型
                if (!fileInput.files[0].type.match('image.*')) {
                    showAlert('请上传图片文件', 'warning');
                    fileInput.value = '';
                    previewElement.innerHTML = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewElement.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="图片预览">`;
                };
                
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                previewElement.innerHTML = '';
            }
        }
        
        // 上传图片到Supabase存储
        async function uploadImageToSupabase(file, bucketName) {
            if (!file) return null;
            
            showLoading(true);
            try {
                // 生成文件名：使用时间戳和随机数
                const fileName = `${bucketName}_${Date.now()}_${Math.floor(Math.random() * 1000)}.${file.name.split('.').pop()}`;
                
                // 先检查存储桶是否存在，如果不存在则创建
                try {
                    await createStorageBucketIfNotExists(bucketName);
                } catch (error) {
                    console.warn('创建存储桶失败:', error);
                    // 继续尝试上传，可能存储桶已经存在
                }
                
                // 上传到Supabase存储
                const response = await fetch(`${SUPABASE_URL}/storage/v1/object/${bucketName}/${fileName}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                        'Content-Type': file.type
                    },
                    body: file
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`上传失败: ${errorText}`);
                }
                
                // 获取公共URL
                const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/${bucketName}/${fileName}`;
                
                return imageUrl;
            } catch (error) {
                console.error('上传图片失败:', error);
                showAlert('上传图片失败: ' + error.message, 'danger');
                return null;
            } finally {
                showLoading(false);
            }
        }
        
        // 上传视频到Supabase存储
        async function uploadVideoToSupabase(file, bucketName) {
            if (!file) return null;
            
            showLoading(true);
            try {
                // 生成文件名：使用时间戳和随机数
                const fileName = `${bucketName}_${Date.now()}_${Math.floor(Math.random() * 1000)}.${file.name.split('.').pop()}`;
                
                // 先检查存储桶是否存在，如果不存在则创建
                try {
                    await createStorageBucketIfNotExists(bucketName);
                } catch (error) {
                    console.warn('创建存储桶失败:', error);
                    // 继续尝试上传，可能存储桶已经存在
                }
                
                // 上传到Supabase存储
                const response = await fetch(`${SUPABASE_URL}/storage/v1/object/${bucketName}/${fileName}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                        'Content-Type': file.type
                    },
                    body: file
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`上传失败: ${errorText}`);
                }
                
                // 获取公共URL
                const videoUrl = `${SUPABASE_URL}/storage/v1/object/public/${bucketName}/${fileName}`;
                
                return videoUrl;
            } catch (error) {
                console.error('上传视频失败:', error);
                showAlert('上传视频失败: ' + error.message, 'danger');
                return null;
            } finally {
                showLoading(false);
            }
        }
        
        // 创建存储桶（如果不存在）
        async function createStorageBucketIfNotExists(bucketName) {
            // 检查存储桶是否存在
            const response = await fetch(`${SUPABASE_URL}/storage/v1/bucket`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`
                }
            });
            
            if (response.ok) {
                const buckets = await response.json();
                const bucketExists = buckets.some(bucket => bucket.name === bucketName);
                
                if (!bucketExists) {
                    // 创建存储桶
                    const createResponse = await fetch(`${SUPABASE_URL}/storage/v1/bucket`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: bucketName,
                            public: true,
                            file_size_limit: 52428800 // 50MB
                        })
                    });
                    
                    if (!createResponse.ok) {
                        throw new Error('创建存储桶失败');
                    }
                }
            } else {
                throw new Error('获取存储桶列表失败');
            }
        }
        
        // 加载系统设置
        function loadSettings() {
            // 更新服务器时间
            document.getElementById('serverTime').textContent = new Date().toLocaleString();
            // 更新机器人状态
            document.getElementById('currentBotStatus').textContent = '运行中';
            document.getElementById('botStatusSwitch').checked = true;
        }
        
        // 切换机器人状态
        function toggleBotStatus() {
            const newStatus = !document.getElementById('botStatusSwitch').checked;
            showLoading(true);
            // 这里只是模拟切换状态，实际需要修改代码中的EMERGENCY_STOP变量
            // 由于Worker是无状态的，这个功能需要通过其他方式实现
            showAlert('机器人状态已切换', 'success');
            document.getElementById('botStatusSwitch').checked = !newStatus;
            document.getElementById('currentBotStatus').textContent = newStatus ? '已停止' : '运行中';
            showLoading(false);
        }
        
        // 检查数据库状态
        function checkDbStatus() {
            showLoading(true);
            directSupabaseFetch('users', 'limit=1')
            .then(() => {
                document.getElementById('dbStatus').textContent = '已连接';
                document.getElementById('dbStatus').className = 'badge bg-success';
                document.getElementById('dbLastCheck').textContent = new Date().toLocaleString();
                showAlert('数据库连接正常', 'success');
            })
            .catch(error => {
                document.getElementById('dbStatus').textContent = '连接失败';
                document.getElementById('dbStatus').className = 'badge bg-danger';
                document.getElementById('dbLastCheck').textContent = new Date().toLocaleString();
                showAlert('数据库连接失败: ' + error.message, 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // 渲染分页
        function renderPagination(type, totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            let html = '';
            // 上一页
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage('${type}', ${currentPage - 1})">上一页</a>
            </li>`;
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage('${type}', ${i})">${i}</a>
                    </li>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            // 下一页
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage('${type}', ${currentPage + 1})">下一页</a>
            </li>`;
            
            const paginationElement = document.getElementById(type + 'Pagination');
            if (paginationElement) {
                paginationElement.innerHTML = html;
            }
        }
        
        // 切换页面
        function changePage(type, page) {
            currentPage[type] = page;
            switch(type) {
                case 'users':
                    renderUsersTable();
                    break;
                case 'teachers':
                    renderTeachersTable();
                    break;
                case 'keywords':
                    renderKeywordsTable();
                    break;
                case 'banned':
                    renderBannedTable();
                    break;
                case 'scheduled':
                    renderScheduledTasksTable();
                    break;
            }
        }
        
        // 获取状态徽章
        function getStatusBadge(status) {
            switch(status) {
                case 'pending':
                    return '<span class="badge bg-warning">待审核</span>';
                case 'approved':
                    return '<span class="badge bg-success">已通过</span>';
                case 'rejected':
                    return '<span class="badge bg-danger">已拒绝</span>';
                default:
                    return '<span class="badge bg-secondary">未知</span>';
            }
        }
        
        // 直接从Supabase获取数据
        async function directSupabaseFetch(table, filter = "") {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${filter}`, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Supabase错误: ${errorData.message || response.statusText}`);
            }
            return await response.json();
        }
        
        // 使用服务角色密钥从Supabase获取数据
        async function directSupabaseFetchWithServiceKey(table, filter = "") {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${filter}`, {
                headers: {
                    'apikey': SUPABASE_SERVICE_KEY,
                    'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Supabase错误: ${errorData.message || response.statusText}`);
            }
            return await response.json();
        }
        
        // 直接向Supabase插入数据
        async function directSupabaseInsert(table, data) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Supabase insert错误: ${errorData.message || response.statusText}`);
            }
        }
        
        // 使用服务角色密钥插入数据
        async function directSupabaseInsertWithServiceKey(table, data) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_SERVICE_KEY,
                    'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Supabase insert错误: ${errorData.message || response.statusText}`);
            }
        }
        
        // 直接向Supabase更新数据
        async function directSupabaseUpsert(table, data, conflictColumn) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?on_conflict=${conflictColumn}`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'resolution=merge-duplicates'
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Supabase upsert错误: ${errorData.message || response.statusText}`);
            }
        }
        
        // 使用服务角色密钥更新数据
        async function directSupabaseUpsertWithServiceKey(table, data, conflictColumn) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?on_conflict=${conflictColumn}`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_SERVICE_KEY,
                    'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'resolution=merge-duplicates'
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Supabase upsert错误: ${errorData.message || response.statusText}`);
            }
        }
        
        // 直接从Supabase删除数据
        async function directSupabaseDelete(table, id) {
            const idColumn = table === 'users' ? 'user_id' : 'id';
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${idColumn}=eq.${id}`, {
                method: 'DELETE',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Supabase delete错误: ${errorData.message || response.statusText}`);
            }
        }
        
        // 使用服务角色密钥删除数据
        async function directSupabaseDeleteWithServiceKey(table, id) {
            const idColumn = table === 'users' ? 'user_id' : 'id';
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${idColumn}=eq.${id}`, {
                method: 'DELETE',
                headers: {
                    'apikey': SUPABASE_SERVICE_KEY,
                    'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`
                }
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Supabase delete错误: ${errorData.message || response.statusText}`);
            }
        }
        
        // 显示提示
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            // 自动关闭
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    const bsAlert = new bootstrap.Alert(alertElement);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        // 显示/隐藏加载动画
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>

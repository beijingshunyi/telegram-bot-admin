<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        success: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B'
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card {
                @apply bg-white rounded-lg shadow p-6 mb-6;
            }
            .btn {
                @apply px-4 py-2 rounded font-medium transition-colors;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90;
            }
            .btn-warning {
                @apply bg-warning text-white hover:bg-warning/90;
            }
            .error-message {
                @apply bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4;
            }
            .success-message {
                @apply bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4;
            }
            .status-badge {
                @apply px-2 py-1 rounded-full text-xs font-medium;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">数据库管理系统</h1>
            <p class="text-gray-600">连接并管理您的数据库表，修复权限和结构问题</p>
        </header>
        
        <!-- 数据库连接设置 -->
        <div id="connection-settings" class="card">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-database mr-2 text-primary"></i>数据库连接设置
            </h2>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="db-url">
                    数据库URL <span class="text-danger">*</span>
                </label>
                <input type="text" id="db-url" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                       placeholder="例如: https://your-project.supabase.co">
                <p class="text-xs text-gray-500 mt-1">您的Supabase项目URL</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 mb-2" for="db-key">
                    服务密钥 <span class="text-danger">*</span>
                </label>
                <input type="text" id="db-key" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                       placeholder="输入Supabase服务密钥">
                <p class="text-xs text-danger mt-1">
                    请使用service_role密钥（非anon密钥），可在Supabase控制台的项目设置->API中找到
                </p>
            </div>
            
            <button id="connect-btn" class="btn btn-primary">
                <i class="fa fa-plug mr-1"></i> 连接数据库
            </button>
            
            <div id="connection-result" class="mt-4 hidden"></div>
        </div>
        
        <!-- 数据库修复工具 -->
        <div id="database-tools" class="hidden">
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-wrench mr-2 text-warning"></i>数据库修复工具
                </h2>
                
                <p class="text-gray-600 mb-4">使用以下工具修复常见的数据库问题</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <button id="fix-permissions-btn" class="btn btn-warning flex items-center justify-center">
                        <i class="fa fa-key mr-2"></i> 修复所有表权限
                    </button>
                    
                    <button id="create-banned-table-btn" class="btn btn-warning flex items-center justify-center">
                        <i class="fa fa-table mr-2"></i> 创建禁言词表
                    </button>
                    
                    <button id="detect-fields-btn" class="btn btn-success flex items-center justify-center">
                        <i class="fa fa-search mr-2"></i> 自动检测用户表字段
                    </button>
                    
                    <button id="one-click-fix-btn" class="btn bg-purple-600 hover:bg-purple-700 text-white flex items-center justify-center">
                        <i class="fa fa-magic mr-2"></i> 一键修复所有问题
                    </button>
                </div>
                
                <div id="fix-result" class="mt-4 hidden"></div>
            </div>
            
            <!-- 用户管理 -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-users mr-2 text-primary"></i>用户管理
                </h2>
                
                <div id="users-error" class="error-message hidden"></div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">显示名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">积分</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最后签到</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                                    请先连接数据库
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 老师管理 -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-user-md mr-2 text-primary"></i>老师管理
                </h2>
                
                <div id="teachers-error" class="error-message hidden"></div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">花名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">年龄</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">地区</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="teachers-table-body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                                    请先连接数据库
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 关键词管理 -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-key mr-2 text-primary"></i>关键词回复管理
                </h2>
                
                <div id="keywords-error" class="error-message hidden"></div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">关键词</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">回复内容</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="keywords-table-body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-6 py-10 text-center text-gray-500">
                                    请先连接数据库
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 禁言词管理 -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-ban mr-2 text-primary"></i>禁言词管理
                </h2>
                
                <div id="banned-words-error" class="error-message hidden"></div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">禁言词</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="banned-words-table-body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="2" class="px-6 py-10 text-center text-gray-500">
                                    请先连接数据库
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- SQL执行模态框 -->
        <div id="sql-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">执行SQL命令</h3>
                    <p class="text-gray-600 mt-1">请复制以下SQL到Supabase的SQL编辑器中执行</p>
                </div>
                <div class="p-6">
                    <textarea id="sql-command" class="w-full h-60 p-4 border border-gray-300 rounded-md font-mono text-sm" readonly></textarea>
                    
                    <div class="mt-4 flex justify-end">
                        <button id="copy-sql-btn" class="btn mr-2 border border-gray-300 hover:bg-gray-100">
                            <i class="fa fa-copy mr-1"></i> 复制SQL
                        </button>
                        <button id="close-sql-modal" class="btn btn-primary">
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 用户编辑模态框 -->
        <div id="user-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg w-full max-w-md p-6">
                <h3 class="text-xl font-bold mb-4">编辑用户</h3>
                <input type="hidden" id="edit-user-id">
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="edit-username">
                        用户名
                    </label>
                    <input type="text" id="edit-username" class="w-full px-3 py-2 border border-gray-300 rounded-md" readonly>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="edit-display-name">
                        显示名称
                    </label>
                    <input type="text" id="edit-display-name" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="edit-points">
                        积分
                    </label>
                    <input type="number" id="edit-points" class="w-full px-3 py-2 border border-gray-300 rounded-md" min="0">
                </div>
                
                <div class="flex justify-end mt-6">
                    <button id="cancel-user-edit" class="btn mr-2 border border-gray-300 hover:bg-gray-100">
                        取消
                    </button>
                    <button id="save-user-edit" class="btn btn-primary">
                        保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局状态
        const state = {
            supabase: null,
            connected: false,
            // 字段映射 - 解决ID显示undefined问题
            userFields: {
                id: 'id',           // 用户ID字段名
                username: 'username', // 用户名字段名
                displayName: 'display_name', // 显示名称字段名
                points: 'points',   // 积分字段名
                lastSignIn: 'last_sign_in' // 最后签到字段名
            }
        };

        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 尝试从本地存储加载连接信息
            loadConnectionSettings();
            
            // 绑定事件处理程序
            bindEvents();
        });

        // 绑定所有事件处理程序
        function bindEvents() {
            // 连接按钮
            document.getElementById('connect-btn').addEventListener('click', connectToDatabase);
            
            // 修复工具按钮
            document.getElementById('fix-permissions-btn').addEventListener('click', fixTablePermissions);
            document.getElementById('create-banned-table-btn').addEventListener('click', createBannedWordsTable);
            document.getElementById('detect-fields-btn').addEventListener('click', detectUserTableFields);
            document.getElementById('one-click-fix-btn').addEventListener('click', oneClickFix);
            
            // SQL模态框按钮
            document.getElementById('copy-sql-btn').addEventListener('click', copySqlToClipboard);
            document.getElementById('close-sql-modal').addEventListener('click', () => {
                document.getElementById('sql-modal').classList.add('hidden');
            });
            
            // 用户编辑模态框按钮
            document.getElementById('cancel-user-edit').addEventListener('click', () => {
                document.getElementById('user-edit-modal').classList.add('hidden');
            });
            document.getElementById('save-user-edit').addEventListener('click', saveUserChanges);
        }

        // 从本地存储加载连接设置
        function loadConnectionSettings() {
            const savedUrl = localStorage.getItem('dbUrl');
            const savedKey = localStorage.getItem('dbKey');
            
            if (savedUrl) {
                document.getElementById('db-url').value = savedUrl;
            }
            
            if (savedKey) {
                document.getElementById('db-key').value = savedKey;
            }
        }

        // 保存连接设置到本地存储
        function saveConnectionSettings(url, key) {
            localStorage.setItem('dbUrl', url);
            localStorage.setItem('dbKey', key);
        }

        // 连接到数据库
        async function connectToDatabase() {
            const url = document.getElementById('db-url').value.trim();
            const key = document.getElementById('db-key').value.trim();
            const resultElement = document.getElementById('connection-result');
            
            // 验证输入
            if (!url || !key) {
                showResult(resultElement, '请填写数据库URL和服务密钥', 'error');
                return;
            }
            
            // 显示连接中状态
            showResult(resultElement, '<i class="fa fa-spinner fa-spin mr-2"></i>正在连接数据库...', 'info');
            
            try {
                // 初始化Supabase客户端
                state.supabase = window.supabase.createClient(url, key);
                
                // 测试连接 - 尝试查询users表
                const { error } = await state.supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    // 处理连接错误
                    if (error.message.includes('permission denied')) {
                        showResult(resultElement, `连接失败: 权限不足 - ${error.message}`, 'error');
                    } else if (error.message.includes('Could not find the table')) {
                        showResult(resultElement, `连接成功，但表不存在: ${error.message}`, 'warning');
                        state.connected = true;
                        showDatabaseTools();
                        saveConnectionSettings(url, key);
                    } else {
                        showResult(resultElement, `连接失败: ${error.message}`, 'error');
                    }
                    return;
                }
                
                // 连接成功
                state.connected = true;
                saveConnectionSettings(url, key);
                showResult(resultElement, '<i class="fa fa-check-circle mr-2"></i>数据库连接成功', 'success');
                
                // 显示数据库工具和加载数据
                showDatabaseTools();
                loadAllTables();
                
            } catch (err) {
                showResult(resultElement, `连接错误: ${err.message}`, 'error');
                console.error('数据库连接错误:', err);
            }
        }

        // 显示数据库工具区域
        function showDatabaseTools() {
            document.getElementById('database-tools').classList.remove('hidden');
        }

        // 显示操作结果
        function showResult(element, message, type) {
            element.classList.remove('hidden', 'error-message', 'success-message', 'bg-blue-50', 'border-blue-200', 'text-blue-700', 'px-4', 'py-3', 'rounded');
            
            if (type === 'error') {
                element.classList.add('error-message');
            } else if (type === 'success') {
                element.classList.add('success-message');
            } else {
                element.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-700', 'px-4', 'py-3', 'rounded');
            }
            
            element.innerHTML = message;
        }

        // 加载所有表数据
        async function loadAllTables() {
            loadUsersTable();
            loadTeachersTable();
            loadKeywordsTable();
            loadBannedWordsTable();
        }

        // 加载用户表数据
        async function loadUsersTable() {
            if (!state.connected || !state.supabase) return;
            
            const tableBody = document.getElementById('users-table-body');
            const errorElement = document.getElementById('users-error');
            
            // 显示加载状态
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                        <i class="fa fa-spinner fa-spin mr-2"></i> 加载用户数据中...
                    </td>
                </tr>
            `;
            errorElement.classList.add('hidden');
            
            try {
                // 查询用户表
                const { data, error } = await state.supabase
                    .from('users')
                    .select('*')
                    .order(state.userFields.lastSignIn || 'created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                                没有找到用户数据
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // 渲染用户表格
                tableBody.innerHTML = data.map(user => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">${user[state.userFields.id] || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user[state.userFields.username] || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user[state.userFields.displayName] || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user[state.userFields.points] || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${user[state.userFields.lastSignIn] ? formatDate(user[state.userFields.lastSignIn]) : '从未'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="openUserEditModal('${user[state.userFields.id]}')" 
                                    class="text-primary hover:text-primary/80">
                                <i class="fa fa-pencil mr-1"></i> 编辑
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('加载用户表失败:', error);
                errorElement.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i> 加载失败: ${error.message}`;
                errorElement.classList.remove('hidden');
                
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                            无法加载用户数据
                        </td>
                    </tr>
                `;
            }
        }

        // 加载老师表数据
        async function loadTeachersTable() {
            if (!state.connected || !state.supabase) return;
            
            const tableBody = document.getElementById('teachers-table-body');
            const errorElement = document.getElementById('teachers-error');
            
            // 显示加载状态
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                        <i class="fa fa-spinner fa-spin mr-2"></i> 加载老师数据中...
                    </td>
                </tr>
            `;
            errorElement.classList.add('hidden');
            
            try {
                // 查询老师表
                const { data, error } = await state.supabase
                    .from('teachers')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                                没有找到老师数据
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // 渲染老师表格
                tableBody.innerHTML = data.map(teacher => {
                    let statusClass = '';
                    let statusText = '';
                    
                    switch (teacher.status) {
                        case 'approved':
                            statusClass = 'bg-green-100 text-green-800';
                            statusText = '已通过';
                            break;
                        case 'rejected':
                            statusClass = 'bg-red-100 text-red-800';
                            statusText = '已拒绝';
                            break;
                        default:
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            statusText = '待审核';
                    }
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">${teacher.id || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${teacher.nickname || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${teacher.age || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${teacher.region || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button class="text-primary hover:text-primary/80 mr-3">
                                    <i class="fa fa-pencil mr-1"></i> 编辑
                                </button>
                                <button class="text-danger hover:text-danger/80">
                                    <i class="fa fa-trash mr-1"></i> 删除
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('加载老师表失败:', error);
                errorElement.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i> 加载失败: ${error.message}
                    ${error.message.includes('permission denied') ? '<br><button onclick="fixTablePermissions()" class="text-primary mt-1 inline-block">点击修复权限</button>' : ''}`;
                errorElement.classList.remove('hidden');
                
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                            无法加载老师数据
                        </td>
                    </tr>
                `;
            }
        }

        // 加载关键词表数据
        async function loadKeywordsTable() {
            if (!state.connected || !state.supabase) return;
            
            const tableBody = document.getElementById('keywords-table-body');
            const errorElement = document.getElementById('keywords-error');
            
            // 显示加载状态
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-10 text-center text-gray-500">
                        <i class="fa fa-spinner fa-spin mr-2"></i> 加载关键词数据中...
                    </td>
                </tr>
            `;
            errorElement.classList.add('hidden');
            
            try {
                // 查询关键词表
                const { data, error } = await state.supabase
                    .from('keywords')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-10 text-center text-gray-500">
                                没有找到关键词数据
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // 渲染关键词表格
                tableBody.innerHTML = data.map(keyword => {
                    const statusClass = keyword.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                    const statusText = keyword.active ? '启用' : '禁用';
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap font-medium">${keyword.text || '-'}</td>
                            <td class="px-6 py-4">${truncateText(keyword.response || '', 50)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button class="text-primary hover:text-primary/80 mr-3">
                                    <i class="fa fa-pencil mr-1"></i> 编辑
                                </button>
                                <button class="text-danger hover:text-danger/80">
                                    <i class="fa fa-trash mr-1"></i> 删除
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('加载关键词表失败:', error);
                errorElement.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i> 加载失败: ${error.message}
                    ${error.message.includes('permission denied') ? '<br><button onclick="fixTablePermissions()" class="text-primary mt-1 inline-block">点击修复权限</button>' : ''}`;
                errorElement.classList.remove('hidden');
                
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-10 text-center text-gray-500">
                            无法加载关键词数据
                        </td>
                    </tr>
                `;
            }
        }

        // 加载禁言词表数据
        async function loadBannedWordsTable() {
            if (!state.connected || !state.supabase) return;
            
            const tableBody = document.getElementById('banned-words-table-body');
            const errorElement = document.getElementById('banned-words-error');
            
            // 显示加载状态
            tableBody.innerHTML = `
                <tr>
                    <td colspan="2" class="px-6 py-10 text-center text-gray-500">
                        <i class="fa fa-spinner fa-spin mr-2"></i> 加载禁言词数据中...
                    </td>
                </tr>
            `;
            errorElement.classList.add('hidden');
            
            try {
                // 查询禁言词表
                const { data, error } = await state.supabase
                    .from('banned_words')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="2" class="px-6 py-10 text-center text-gray-500">
                                没有找到禁言词数据
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // 渲染禁言词表格
                tableBody.innerHTML = data.map(word => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${word.word || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="text-primary hover:text-primary/80 mr-3">
                                <i class="fa fa-pencil mr-1"></i> 编辑
                            </button>
                            <button class="text-danger hover:text-danger/80">
                                <i class="fa fa-trash mr-1"></i> 删除
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('加载禁言词表失败:', error);
                errorElement.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i> 加载失败: ${error.message}
                    ${error.message.includes('Could not find the table') ? '<br><button onclick="createBannedWordsTable()" class="text-primary mt-1 inline-block">点击创建表</button>' : ''}
                    ${error.message.includes('permission denied') ? '<br><button onclick="fixTablePermissions()" class="text-primary mt-1 inline-block">点击修复权限</button>' : ''}`;
                errorElement.classList.remove('hidden');
                
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="2" class="px-6 py-10 text-center text-gray-500">
                            无法加载禁言词数据
                        </td>
                    </tr>
                `;
            }
        }

        // 修复表权限
        function fixTablePermissions() {
            // 生成修复权限的SQL
            const sql = `
-- 授予schema权限
GRANT USAGE ON SCHEMA public TO anon, authenticated, service_role;

-- 授予所有表的权限
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.users TO anon, authenticated, service_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.teachers TO anon, authenticated, service_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.keywords TO anon, authenticated, service_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.banned_words TO anon, authenticated, service_role;
            `.trim();
            
            // 显示SQL模态框
            document.getElementById('sql-command').value = sql;
            document.getElementById('sql-modal').classList.remove('hidden');
        }

        // 创建禁言词表
        function createBannedWordsTable() {
            // 生成创建表的SQL
            const sql = `
-- 创建禁言词表
CREATE TABLE IF NOT EXISTS public.banned_words (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    word TEXT NOT NULL UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 添加索引提高查询性能
CREATE INDEX IF NOT EXISTS idx_banned_words_word ON public.banned_words (word);

-- 授予权限
GRANT USAGE ON SCHEMA public TO anon, authenticated, service_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.banned_words TO anon, authenticated, service_role;
            `.trim();
            
            // 显示SQL模态框
            document.getElementById('sql-command').value = sql;
            document.getElementById('sql-modal').classList.remove('hidden');
        }

        // 自动检测用户表字段
        async function detectUserTableFields() {
            if (!state.connected || !state.supabase) {
                alert('请先连接数据库');
                return;
            }
            
            const resultElement = document.getElementById('fix-result');
            showResult(resultElement, '<i class="fa fa-spinner fa-spin mr-2"></i>正在检测用户表字段...', 'info');
            
            try {
                // 获取用户表的第一条记录，分析字段
                const { data, error } = await state.supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    showResult(resultElement, '用户表中没有数据，无法检测字段', 'error');
                    return;
                }
                
                const user = data[0];
                const fields = Object.keys(user);
                const newFieldMap = { ...state.userFields };
                
                // 尝试自动匹配字段
                fields.forEach(field => {
                    // 匹配ID字段
                    if (['id', 'user_id', 'uid'].includes(field.toLowerCase()) && !newFieldMap.id) {
                        newFieldMap.id = field;
                    }
                    // 匹配用户名字段
                    if (['username', 'user_name', 'name'].includes(field.toLowerCase()) && !newFieldMap.username) {
                        newFieldMap.username = field;
                    }
                    // 匹配显示名称字段
                    if (['display_name', 'nickname', 'show_name'].includes(field.toLowerCase()) && !newFieldMap.displayName) {
                        newFieldMap.displayName = field;
                    }
                    // 匹配积分字段
                    if (['points', 'score', 'credits'].includes(field.toLowerCase()) && !newFieldMap.points) {
                        newFieldMap.points = field;
                    }
                    // 匹配最后签到字段
                    if (['last_sign_in', 'last_login', 'updated_at'].includes(field.toLowerCase()) && !newFieldMap.lastSignIn) {
                        newFieldMap.lastSignIn = field;
                    }
                });
                
                // 保存新的字段映射
                state.userFields = newFieldMap;
                
                // 显示检测结果
                let resultHtml = '<i class="fa fa-check-circle mr-2"></i>用户表字段检测完成:<br>';
                resultHtml += `<ul class="list-disc pl-5 mt-2">`;
                resultHtml += `<li>ID字段: ${newFieldMap.id || '<span class="text-danger">未找到</span>'}</li>`;
                resultHtml += `<li>用户名字段: ${newFieldMap.username || '<span class="text-danger">未找到</span>'}</li>`;
                resultHtml += `<li>显示名称字段: ${newFieldMap.displayName || '<span class="text-danger">未找到</span>'}</li>`;
                resultHtml += `<li>积分字段: ${newFieldMap.points || '<span class="text-danger">未找到</span>'}</li>`;
                resultHtml += `<li>最后签到字段: ${newFieldMap.lastSignIn || '<span class="text-danger">未找到</span>'}</li>`;
                resultHtml += `</ul>`;
                
                showResult(resultElement, resultHtml, 'success');
                
                // 重新加载用户表
                loadUsersTable();
                
            } catch (error) {
                console.error('检测用户表字段失败:', error);
                showResult(resultElement, `检测失败: ${error.message}`, 'error');
            }
        }

        // 一键修复所有问题
        function oneClickFix() {
            if (!confirm('确定要执行一键修复吗？这将尝试修复所有检测到的问题。')) {
                return;
            }
            
            // 生成包含所有修复操作的SQL
            const sql = `
-- 一键修复所有数据库问题

-- 1. 授予所有表权限
GRANT USAGE ON SCHEMA public TO anon, authenticated, service_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.users TO anon, authenticated, service_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.teachers TO anon, authenticated, service_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.keywords TO anon, authenticated, service_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.banned_words TO anon, authenticated, service_role;

-- 2. 创建禁言词表（如果不存在）
CREATE TABLE IF NOT EXISTS public.banned_words (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    word TEXT NOT NULL UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. 为禁言词表添加索引
CREATE INDEX IF NOT EXISTS idx_banned_words_word ON public.banned_words (word);
            `.trim();
            
            // 显示SQL模态框
            document.getElementById('sql-command').value = sql;
            document.getElementById('sql-modal').classList.remove('hidden');
        }

        // 复制SQL到剪贴板
        function copySqlToClipboard() {
            const sqlElement = document.getElementById('sql-command');
            sqlElement.select();
            document.execCommand('copy');
            
            // 显示复制成功提示
            const originalText = document.getElementById('copy-sql-btn').innerHTML;
            document.getElementById('copy-sql-btn').innerHTML = '<i class="fa fa-check mr-1"></i> 已复制';
            
            setTimeout(() => {
                document.getElementById('copy-sql-btn').innerHTML = originalText;
            }, 2000);
        }

        // 打开用户编辑模态框
        function openUserEditModal(userId) {
            if (!state.connected || !state.supabase) return;
            
            // 查找用户数据
            const findUser = async () => {
                try {
                    const { data, error } = await state.supabase
                        .from('users')
                        .select('*')
                        .eq(state.userFields.id, userId)
                        .single();
                    
                    if (error) throw error;
                    if (!data) return;
                    
                    // 填充表单
                    document.getElementById('edit-user-id').value = userId;
                    document.getElementById('edit-username').value = data[state.userFields.username] || '';
                    document.getElementById('edit-display-name').value = data[state.userFields.displayName] || '';
                    document.getElementById('edit-points').value = data[state.userFields.points] || 0;
                    
                    // 显示模态框
                    document.getElementById('user-edit-modal').classList.remove('hidden');
                    
                } catch (error) {
                    console.error('获取用户数据失败:', error);
                    alert(`无法加载用户数据: ${error.message}`);
                }
            };
            
            findUser();
        }

        // 保存用户编辑
        async function saveUserChanges() {
            const userId = document.getElementById('edit-user-id').value;
            const displayName = document.getElementById('edit-display-name').value.trim();
            const points = document.getElementById('edit-points').value;
            
            if (!userId) return;
            
            try {
                // 构建更新数据
                const updates = {
                    [state.userFields.displayName]: displayName,
                    [state.userFields.points]: parseInt(points),
                    updated_at: new Date().toISOString()
                };
                
                // 执行更新
                const { error } = await state.supabase
                    .from('users')
                    .update(updates)
                    .eq(state.userFields.id, userId);
                
                if (error) throw error;
                
                // 关闭模态框并刷新表格
                document.getElementById('user-edit-modal').classList.add('hidden');
                loadUsersTable();
                
                // 显示成功消息
                const resultElement = document.getElementById('fix-result');
                showResult(resultElement, '<i class="fa fa-check-circle mr-2"></i>用户信息已更新', 'success');
                
            } catch (error) {
                console.error('保存用户信息失败:', error);
                alert(`保存失败: ${error.message}`);
            }
        }

        // 辅助函数：格式化日期
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '无效日期';
            
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 辅助函数：截断文本
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
    </script>
</body>
</html>
    
